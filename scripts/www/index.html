<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æç®€Â·é»‘ç™½ Â· ç»ˆç‰ˆ Â· é«˜äº®è¿”å› Â· å°é¢æœç´¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ===== å…¨å±€é»‘ç™½ç° â€”â€”â€” åŸºç¡€è§†è§‰å®Œå…¨ä¿ç•™ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player {
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* ===== ä¸»å†…å®¹åŒºåŸŸâ€”â€”å…¨å±€æ»šåŠ¨æ¡ï¼ŒåŒ…å«å¯è§†åŒ– ===== */
        .player-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px 24px 0;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
            transition: scrollbar-color 0.2s;
        }
        .player-main:hover {
            scrollbar-color: #a0a0a0 #f0f0f0;
        }
        .player-main::-webkit-scrollbar {
            width: 4px;
            background: transparent;
        }
        .player-main::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 4px;
        }
        .player-main:hover::-webkit-scrollbar-thumb {
            background: #a0a0a0;
        }
        .player-main:hover::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        /* ----- å°é¢/æ­Œè¯/æœ€è¿‘æ’­æ”¾ ä¸‰åˆä¸€åŒºåŸŸï¼ˆç‚¹å‡»å¾ªç¯åˆ‡æ¢ï¼‰----- */
        .album-lyrics-toggle {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f7f7f7;
            border: 1px solid #e2e2e2;
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            flex-shrink: 0;
        }

        .cover-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6f6f6f;
            width: 100%;
            height: 100%;
            position: relative;
        }
        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            display: block;
        }
        /* å°é¢æœç´¢æŒ‰é’®â€”â€”ä»…åœ¨æ— å°é¢æ—¶æ˜¾ç¤º */
        .cover-search-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #2b2b2b;
            font-size: 1.2rem;
            transition: 0.1s;
            z-index: 10;
        }
        .cover-search-btn:hover {
            background: #f0f0f0;
        }

        /* æ­Œè¯å®¹å™¨ï¼šå·¦ä¾§æ­Œè¯ + å³ä¸‹è§’åç§»æŒ‰é’® */
        .lyrics-container {
            width: 100%;
            height: 100%;
            padding: 16px;
            font-size: 0.95rem;
            line-height: 1.7;
            color: #2a2a2a;
            white-space: pre-wrap;
            overflow-y: auto;
            background: white;
            display: none;
            flex-direction: row;
        }
        .lyrics-left {
            flex: 1;
            overflow-y: auto;
            padding-right: 12px;
        }
        .lyrics-right {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            width: 48px;
            padding-bottom: 12px;
            margin-top: auto;
        }
        .lyric-offset-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: #1a1a1a;
        }
        .lyric-offset-reset {
            background: white;
            border: 1px solid #8a8a8a;
            border-radius: 30px;
            padding: 8px 0;
            width: 40px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            margin-bottom: 12px;
        }
        .lyric-search-bar {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
            padding-bottom: 10px;
            width: 100%;
        }
        .lyric-search-input {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 0.85rem;
            outline: none;
            background: white;
        }
        .lyric-search-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 30px;
            padding: 8px 16px;
            margin-left: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .lyrics-line {
            padding: 6px 0;
            border-bottom: 0.5px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.1s;
        }
        .lyrics-line:hover { background: #f5f5f5; }
        .lyrics-line.active {
            background: #e0e0e0;
            font-weight: 600;
            border-left: 3px solid #1a1a1a;
            padding-left: 9px;
        }

        /* æœ€è¿‘æ’­æ”¾åˆ—è¡¨ */
        .recent-container {
            width: 100%;
            height: 100%;
            background: white;
            padding: 16px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }
        .recent-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
            border-bottom: 1px solid #ececec;
            padding-bottom: 8px;
        }
        .recent-item {
            padding: 12px 16px;
            background: #fafafa;
            border-radius: 16px;
            margin-bottom: 8px;
            border: 1px solid #efefef;
            cursor: pointer;
            transition: background 0.1s;
        }
        .recent-item.active {
            background: #e0e0e0;
            border-left: 6px solid #1a1a1a;
        }
        .recent-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .recent-item-artist { font-size: 0.8rem; color: #6e6e6e; }

        /* æ­Œæ›²ä¿¡æ¯ */
        .song-info {
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        .song-title {
            font-size: 1.9rem;
            font-weight: 650;
            letter-spacing: -0.5px;
            color: #000;
            line-height: 1.1;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .song-artist {
            font-size: 1rem;
            color: #6a6a6a;
            font-weight: 400;
        }

        /* è¿›åº¦æ¡åŒºåŸŸâ€”â€”ç›¸å¯¹å®šä½ï¼Œç”¨äºéŸ³è´¨æŒ‰é’®ç»å¯¹å®šä½ */
        .progress-section {
            margin-bottom: 12px;
            flex-shrink: 0;
            position: relative;
        }
        .progress-wrapper {
            width: 100%;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ececec;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        .progress-fill {
            width: 0%;
            height: 4px;
            background: #2c2c2c;
            border-radius: 2px;
            transition: width 0.1s linear;
            pointer-events: none;
        }
        .time-row {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.8rem;
            color: #7a7a7a;
        }
        /* éŸ³è´¨åˆ‡æ¢æŒ‰é’®â€”â€”ç»å¯¹å®šä½ï¼Œä½äºè¿›åº¦æ¡æ­£ä¸Šæ–¹å³ä¾§ */
        .quality-switch-container {
            position: absolute;
            right: 0;
            top: -30px;
            display: none;
        }
        .quality-switch-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #1a1a1a;
            white-space: nowrap;
            transition: 0.1s;
        }
        .quality-switch-btn:hover {
            background: #f0f0f0;
        }
        .hidden-select {
            display: none;
        }

        /* æ’­æ”¾æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0 16px;
            flex-shrink: 0;
        }
        .control-btn {
            background: white;
            border: 1px solid #d6d6d6;
            font-size: 1.4rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #2b2b2b;
            transition: 0.1s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            position: relative;
        }
        .control-btn:active { background: #f2f2f2; }
        .play-pause { width: 58px; height: 58px; font-size: 1.8rem; border: 1px solid #a8a8a8; }
        .repeat-one-badge {
            position: absolute; top: 12px; right: 10px;
            background: #2b2b2b; color: white; font-size: 0.7rem; font-weight: 700;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }

        /* ===== æœç´¢åª’ä½“åº“åŒºåŸŸï¼ˆåŸå§‹å¤§å°æ ·å¼ï¼‰===== */
        .main-search-section {
            border-top: 1px solid #f0f0f0;
            padding: 16px 0 12px;
            margin-top: 4px;
            flex-shrink: 0;
        }
        .search-wrapper {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #c8c8c8;
            border-radius: 40px;
            padding: 2px 2px 2px 18px;
            transition: 0.1s;
            width: 100%;
        }
        .search-wrapper:focus-within { border-color: #8a8a8a; }
        .search-input {
            background: transparent;
            border: none;
            padding: 12px 0;
            font-size: 1rem;
            flex: 1;
            outline: none;
            color: #1a1a1a;
        }
        .search-btn {
            background: white;
            border: 1px solid #b0b0b0;
            color: #1a1a1a;
            padding: 10px 22px;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.1s;
        }
        .search-btn:hover { background: #f0f0f0; }

        /* ===== æ­Œå•åŒºåŸŸï¼ˆå®Œå…¨æ˜¾ç¤ºï¼Œä¸å‹ç¼©ï¼‰===== */
        .playlist-section {
            border-top: 1px solid #f0f0f0;
            padding: 16px 0 12px;
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .playlist-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        .playlist-header-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        .add-playlist-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 8px 20px;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .playlist-creator {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
            flex-shrink: 0;
        }
        .playlist-name-input {
            flex: 1;
            border: 1px solid #c2c2c2;
            border-radius: 40px;
            padding: 10px 18px;
            font-size: 0.95rem;
            outline: none;
        }
        .confirm-add-btn {
            background: white;
            border: 1px solid #2a2a2a;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #1a1a1a;
        }
        .playlist-items-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background: #fafafa;
            border-radius: 16px;
            border: 1px solid #efefef;
            cursor: pointer;
            transition: background 0.1s;
            position: relative;
        }
        .playlist-item.selected {
            background: #d4d4d4;
            border: 1.5px solid #4a4a4a;
        }
        .playlist-item-info { flex: 1; }
        .playlist-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .playlist-item-count { font-size: 0.8rem; color: #7a7a7a; margin-left: 8px; }
        .delete-playlist-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            flex-shrink: 0;
        }

        /* ===== å¯è§†åŒ–ï¼šå›ºå®šé«˜åº¦1/10å±å¹•ï¼ŒåŒå³°æ³¢å½¢ ===== */
        .visualizer-section {
            width: 100%;
            height: 10vh;
            min-height: 60px;
            background: #fafafa;
            border-top: 1px solid #e2e2e2;
            border-bottom: 1px solid #e2e2e2;
            margin-top: 8px;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .visualizer-canvas {
            width: 100%;
            height: 90%;
            display: block;
            background: transparent;
        }

        /* ===== ä¸´æ—¶é«˜äº®æ ·å¼ï¼ˆç‚¹å‡»é—ªçƒï¼‰===== */
        .local-item.flash, .detail-item.flash, .search-result-item.flash, .recent-item.flash {
            background: #c0c0c0 !important;
            transition: background 0s;
        }

        /* ===== æœ¬åœ°éŸ³ä¹å…¨å±å¼¹å±‚ ===== */
        .local-music-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex; flex-direction: column;
            padding: 24px 20px;
            transform: scale(0); opacity: 0;
            transition: transform 0.25s cubic-bezier(0.2,0.9,0.3,1), opacity 0.2s;
            transform-origin: center;
            pointer-events: none;
            overflow-y: auto;
        }
        .local-music-modal.show { transform: scale(1); opacity: 1; pointer-events: auto; }
        .local-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; position: relative;
        }
        .local-back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 18px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .local-title {
            font-size: 1.4rem; font-weight: 600; color: #111;
            position: absolute; left: 50%; transform: translateX(-50%);
        }
        .local-add-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 20px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .local-search-wrapper {
            display: flex; align-items: center;
            background: white; border: 1px solid #c8c8c8; border-radius: 40px;
            padding: 2px 2px 2px 18px; width: 100%; margin-bottom: 16px;
        }
        .local-search-input {
            background: transparent; border: none; padding: 12px 0;
            font-size: 0.95rem; flex: 1; outline: none;
        }
        .local-search-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 20px; font-size: 0.9rem; cursor: pointer;
        }
        .local-items-list {
            flex: 1; overflow-y: auto; list-style: none; padding-right: 4px;
        }
        .local-item {
            display: flex; align-items: center; padding: 14px 16px;
            background: #fafafa; border-radius: 16px; margin-bottom: 10px;
            border: 1px solid #efefef; cursor: pointer; transition: background 0.1s;
        }
        .local-item.active {
            background: #e8e8e8;
            border-left: 6px solid #1a1a1a;
        }
        .local-item.selected {
            background: #d0d0d0;
            border: 2px solid #4a4a4a;
        }
        .local-item-info { flex: 1; }
        .local-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .local-item-artist { font-size: 0.85rem; color: #6e6e6e; }

        .local-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0 8px; border-top: 1px solid #ececec; margin-top: 8px;
        }
        .select-all-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 20px; font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .selected-count { font-size: 0.9rem; color: #4a4a4a; }
        .delete-selected-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 20px; font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px; color: #a00;
        }

        /* ===== æ­Œå•è¯¦æƒ…æ¨¡æ€æ¡† ===== */
        .playlist-detail-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            z-index: 2100;
            display: flex; flex-direction: column;
            padding: 24px 20px;
            transform: scale(0); opacity: 0;
            transition: transform 0.25s cubic-bezier(0.2,0.9,0.3,1), opacity 0.2s;
            transform-origin: center;
            pointer-events: none;
            overflow-y: auto;
        }
        .playlist-detail-modal.show { transform: scale(1); opacity: 1; pointer-events: auto; }
        .detail-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; position: relative;
        }
        .detail-back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 18px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .detail-title {
            font-size: 1.4rem; font-weight: 600; color: #111;
            position: absolute; left: 50%; transform: translateX(-50%);
        }
        .detail-add-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 20px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .detail-items-list {
            flex: 1; overflow-y: auto; list-style: none; padding-right: 4px;
        }
        .detail-item {
            display: flex; align-items: center; padding: 14px 16px;
            background: #fafafa; border-radius: 16px; margin-bottom: 10px;
            border: 1px solid #efefef; cursor: pointer; transition: background 0.1s;
        }
        .detail-item.active {
            background: #e8e8e8;
            border-left: 6px solid #1a1a1a;
        }
        .detail-item.selected {
            background: #d0d0d0;
            border: 2px solid #4a4a4a;
        }
        .detail-item-info { flex: 1; }
        .detail-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .detail-item-artist { font-size: 0.85rem; color: #6e6e6e; }
        .detail-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0 8px; border-top: 1px solid #ececec; margin-top: 8px;
        }

        /* éšè—æ–‡ä»¶é€‰æ‹©å™¨ */
        .hidden { display: none !important; }

        /* ===== å…¨å±æœç´¢ç•Œé¢ï¼ˆé€šç”¨ï¼šæ”¯æŒNavidromeæœç´¢ã€å°é¢æœç´¢ï¼‰===== */
        .search-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2500;
            display: flex; flex-direction: column;
            padding: 60px 24px 24px;
            transform: translateX(100%);
            transition: transform 0.25s ease-out;
        }
        .search-modal.show { transform: translateX(0); }
        .back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 12px 24px; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .search-box-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .search-input-large {
            width: 85%;
            max-width: 700px;
            padding: 18px 28px;
            font-size: 1.2rem;
            border: 2px solid #7a7a7a;
            border-radius: 60px;
            outline: none;
            background: white;
            color: #1a1a1a;
        }
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            background: #fafafa;
            border-radius: 20px;
            margin-bottom: 12px;
            border: 1px solid #efefef;
            cursor: pointer;
        }
        .result-info {
            flex: 1;
        }
        .result-title { font-weight: 600; font-size: 1.1rem; color: #000; }
        .result-artist { font-size: 0.9rem; color: #6f6f6f; }
        .result-download-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #2b2b2b;
            margin-left: 12px;
            transition: 0.1s;
        }
        .result-download-btn:hover { background: #f0f0f0; }

        /* å°é¢æœç´¢ç»“æœâ€”â€”æ¨ªå‘æ»šåŠ¨å›¾ç‰‡ */
        .cover-search-results {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding: 8px 4px;
            white-space: nowrap;
        }
        .cover-search-item {
            flex: 0 0 auto;
            width: 160px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: 0.1s;
        }
        .cover-search-item:hover {
            border-color: #1a1a1a;
            transform: scale(0.98);
        }
        .cover-search-item img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="player">
        <!-- ä¸»å†…å®¹åŒºåŸŸâ€”â€”å…¨å±€æ»šåŠ¨ï¼ŒåŒ…å«æ‰€æœ‰å†…å®¹åŠå¯è§†åŒ– -->
        <div class="player-main" id="playerMain">
            <!-- å°é¢/æ­Œè¯/æœ€è¿‘æ’­æ”¾ ä¸‰åˆä¸€åŒºåŸŸ -->
            <div class="album-lyrics-toggle" id="albumLyricsToggle">
                <!-- å°é¢ -->
                <div id="coverDisplay" class="cover-placeholder">
                    <img id="coverImage" class="cover-image" src="" alt="ä¸“è¾‘å°é¢" style="display: none;">
                    <div id="coverIcon" style="display: flex; flex-direction: column; align-items: center;">
                        <i class="fas fa-music" style="font-size: 54px; color: #b0b0b0; margin-bottom: 12px;"></i>
                        <span style="color: #7a7a7a; font-size: 1rem;">ä¸“è¾‘å°é¢</span>
                    </div>
                    <!-- æ‰‹åŠ¨æœç´¢å°é¢æŒ‰é’®ï¼Œæ— å°é¢æ—¶æ˜¾ç¤º -->
                    <div id="coverSearchBtn" class="cover-search-btn" style="display: none;">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <!-- æ­Œè¯å®¹å™¨ -->
                <div id="lyricsDisplay" class="lyrics-container">
                    <div class="lyrics-left">
                        <div class="lyric-search-bar">
                            <input type="text" class="lyric-search-input" id="lyricSearchInput" placeholder="æ­Œæ‰‹ æ­Œå">
                            <button class="lyric-search-btn" id="lyricSearchBtn"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="lyricTextContainer"></div>
                    </div>
                    <div class="lyrics-right">
                        <button class="lyric-offset-btn" id="lyricOffsetUp" title="+0.5ç§’"><i class="fas fa-chevron-up"></i></button>
                        <button class="lyric-offset-reset" id="lyricOffsetReset" title="é‡ç½®åç§»">0.0s</button>
                        <button class="lyric-offset-btn" id="lyricOffsetDown" title="-0.5ç§’"><i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>
                <!-- æœ€è¿‘æ’­æ”¾åˆ—è¡¨ -->
                <div id="recentDisplay" class="recent-container">
                    <div class="recent-title"><i class="fas fa-history"></i> æœ€è¿‘æ’­æ”¾</div>
                    <div id="recentListContainer"></div>
                </div>
            </div>

            <!-- æ­Œæ›²ä¿¡æ¯ -->
            <div class="song-info">
                <div class="song-title" id="nowPlayingTitle">è¿æ¥Navidromeä¸­â€¦</div>
                <div class="song-artist" id="nowPlayingArtist">MrXiao Â· éŸ³ä¹åº“</div>
            </div>

            <!-- è¿›åº¦æ¡åŒºåŸŸ + éŸ³è´¨åˆ‡æ¢æŒ‰é’®ï¼ˆç»å¯¹å®šä½ï¼‰ -->
            <div class="progress-section" id="progressSection">
                <div class="progress-wrapper">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <div class="time-row">
                        <span id="currentTime">00:00</span>
                        <span id="durationTime">00:00</span>
                    </div>
                </div>
                <!-- éŸ³è´¨åˆ‡æ¢å®¹å™¨â€”â€”ç»å¯¹å®šä½åœ¨è¿›åº¦æ¡æ­£ä¸Šæ–¹å³ä¾§ -->
                <div id="qualitySwitchContainer" class="quality-switch-container">
                    <button class="quality-switch-btn" id="qualitySwitchBtn">
                        <i class="fas fa-headphones"></i> éŸ³è´¨
                    </button>
                    <select id="qualitySelect" class="hidden-select">
                        <option value="0">åŸå§‹</option>
                        <option value="128">128kbps</option>
                        <option value="192">192kbps</option>
                        <option value="320" selected>320kbps</option>
                    </select>
                </div>
            </div>

            <!-- æ’­æ”¾æ§åˆ¶æ  -->
            <div class="controls">
                <button class="control-btn" id="loopModeBtn" title="å¾ªç¯æ¨¡å¼"><i class="fas fa-repeat"></i></button>
                <button class="control-btn" id="prevBtn" title="ä¸Šä¸€æ›²"><i class="fas fa-backward"></i></button>
                <button class="control-btn play-pause" id="playPauseBtn" title="æ’­æ”¾/æš‚åœ"><i class="fas fa-play"></i></button>
                <button class="control-btn" id="nextBtn" title="ä¸‹ä¸€æ›²"><i class="fas fa-forward"></i></button>
                <!-- éŸ³å­—æŒ‰é’®ï¼šæ‰“å¼€æœ¬åœ°éŸ³ä¹åº“ -->
                <button class="control-btn" id="sourceToggleBtn" title="æœ¬åœ°éŸ³ä¹">
                    <span style="font-size: 1.4rem; font-weight: 600; color: #1a1a1a;">éŸ³</span>
                </button>
            </div>

            <!-- æœç´¢åª’ä½“åº“åŒºåŸŸ -->
            <div class="main-search-section">
                <div class="search-wrapper">
                    <input type="text" class="search-input" id="mainSearchInput" placeholder="æœç´¢Navidromeæ›²åº“...">
                    <button class="search-btn" id="mainSearchBtn"><i class="fas fa-magnifying-glass"></i> æœç´¢</button>
                </div>
            </div>

            <!-- æ­Œå•åŒºåŸŸ -->
            <div class="playlist-section" id="playlistSection">
                <div class="playlist-header-row">
                    <span class="playlist-header-title"><i class="fas fa-list"></i> æˆ‘çš„æ­Œå•</span>
                    <button class="add-playlist-btn" id="addPlaylistBtn"><i class="fas fa-plus"></i> æ·»åŠ æ­Œå•</button>
                </div>
                <!-- æ­Œå•åˆ›å»ºè¾“å…¥æ¡†ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div id="playlistCreator" style="display: none;" class="playlist-creator">
                    <input type="text" class="playlist-name-input" id="newPlaylistName" placeholder="æ­Œå•åç§°">
                    <button class="confirm-add-btn" id="confirmAddPlaylistBtn"><i class="fas fa-check"></i></button>
                </div>
                <!-- æ­Œå•åˆ—è¡¨å®¹å™¨ -->
                <div id="playlistItemsContainer" class="playlist-items-container"></div>
                <!-- æ­Œå•åˆ é™¤æŒ‰é’®ï¼ˆé€‰æ‹©åæ˜¾ç¤ºï¼‰ -->
                <div id="playlistDeleteBar" style="display: none; justify-content: flex-end; margin-top: 12px; flex-shrink: 0;">
                    <button class="delete-playlist-btn" id="deleteSelectedPlaylistsBtn"><i class="fas fa-trash"></i> åˆ é™¤æ­Œå•</button>
                </div>
            </div>

            <!-- ===== å¯è§†åŒ–åŒºåŸŸâ€”â€”å›ºå®šé«˜åº¦ï¼Œå·²ç§»å…¥æ»šåŠ¨åŒº ===== -->
            <div class="visualizer-section">
                <canvas id="visualizerCanvas" class="visualizer-canvas"></canvas>
            </div>
        </div> <!-- end player-main -->
    </div>

    <!-- ===== æœ¬åœ°éŸ³ä¹å…¨å±å¼¹å±‚ ===== -->
    <div class="local-music-modal" id="localMusicModal">
        <div class="local-header">
            <button class="local-back-btn" id="localBackBtn"><i class="fas fa-arrow-left"></i> è¿”å›</button>
            <span class="local-title">æœ¬åœ°éŸ³ä¹</span>
            <button class="local-add-btn" id="localAddBtn"><i class="fas fa-folder"></i> æ·»åŠ æ–‡ä»¶å¤¹</button>
        </div>
        <div class="local-search-wrapper">
            <input type="text" class="local-search-input" id="localSearchInput" placeholder="åœ¨æœ¬åœ°åˆ—è¡¨ä¸­æœç´¢...">
            <button class="local-search-btn" id="localSearchBtn">æœç´¢</button>
        </div>
        <ul class="local-items-list" id="localItemsList"></ul>
        <div class="local-footer" id="localFooter" style="display: none;">
            <button class="select-all-btn" id="selectAllLocalBtn"><i class="far fa-square"></i> å…¨é€‰</button>
            <span class="selected-count" id="selectedCount">å·²é€‰æ‹© 0 é¦–</span>
            <button class="delete-selected-btn" id="deleteSelectedLocalBtn"><i class="fas fa-trash"></i> åˆ é™¤</button>
        </div>
    </div>

    <!-- ===== æ­Œå•è¯¦æƒ…æ¨¡æ€æ¡† ===== -->
    <div class="playlist-detail-modal" id="playlistDetailModal">
        <div class="detail-header">
            <button class="detail-back-btn" id="detailBackBtn"><i class="fas fa-arrow-left"></i> è¿”å›</button>
            <span class="detail-title" id="detailTitle">æ­Œå•åç§°</span>
            <button class="detail-add-btn" id="detailAddBtn"><i class="fas fa-file"></i> æ·»åŠ æ–‡ä»¶</button>
        </div>
        <ul class="detail-items-list" id="detailItemsList"></ul>
        <div class="detail-footer" id="detailFooter" style="display: none;">
            <button class="select-all-btn" id="selectAllDetailBtn"><i class="far fa-square"></i> å…¨é€‰</button>
            <span class="selected-count" id="detailSelectedCount">å·²é€‰æ‹© 0 é¦–</span>
            <button class="delete-selected-btn" id="deleteSelectedDetailBtn"><i class="fas fa-trash"></i> åˆ é™¤</button>
        </div>
    </div>

    <!-- éšè—æ–‡ä»¶å¤¹é€‰æ‹©å™¨ï¼ˆç”¨äºæ·»åŠ æ–‡ä»¶å¤¹åˆ°æœ¬åœ°ï¼‰ -->
    <input type="file" id="localFolderPicker" webkitdirectory directory multiple accept="audio/*" style="display: none;">
    <!-- éšè—æ–‡ä»¶é€‰æ‹©å™¨ï¼ˆç”¨äºæ·»åŠ æ–‡ä»¶åˆ°æ­Œå•ï¼‰ -->
    <input type="file" id="detailFilePicker" multiple accept="audio/*" style="display: none;">

    <!-- ===== å…¨å±æœç´¢æ¨¡æ€æ¡†ï¼ˆé€šç”¨ï¼šNavidromeæœç´¢ã€å°é¢æœç´¢ï¼‰===== -->
    <div class="search-modal" id="searchModal">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <button class="back-btn" id="closeSearchBtn"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        </div>
        <div class="search-header">
            <div class="search-box-wrapper" style="margin-bottom: 0; flex:1;">
                <input type="text" class="search-input-large" id="searchInputFull" placeholder="æœç´¢..." autofocus style="width: 100%;">
            </div>
        </div>
        <div id="searchResultsContainer" class="search-results"></div>
    </div>

    <script>
        (function() {
            "use strict";

            // ---------- é…ç½® ----------
            const NAV_ID = 'https://music.xscc.love:1314';
            const NAV_USER = 'MrXiao';
            const NAV_PASS = 'xs19910410!!!';

            // ---------- å…¨å±€çŠ¶æ€ ----------
            let currentAudio = null;
            let isPlaying = false;
            let currentSong = null;         // { id, name, artist, source }
            let currentIndex = 0;
            let loopMode = 'list';
            let currentLyrics = [];         // [{ time, text }]
            let displayState = 0;           // 0:å°é¢,1:æ­Œè¯,2:æœ€è¿‘
            let lyricOffset = 0;            // æ­Œè¯åç§»
            
            // å½“å‰éŸ³è´¨
            let currentBitrate = 320;

            // æœ€è¿‘æ’­æ”¾
            let recentPlaylist = [];

            // æœ¬åœ°éŸ³ä¹åˆ—è¡¨
            let localPlaylist = [];

            // Navidrome æ­Œå•
            let navidromePlaylist = [];

            // æˆ‘çš„æ­Œå•
            let userPlaylists = [];

            // å½“å‰æ­Œå•è¯¦æƒ…ID
            let currentDetailPlaylistId = null;

            // æœ¬åœ°éŸ³ä¹é€‰æ‹©çŠ¶æ€
            let selectedLocalIndices = new Set();
            let isLongPressing = false;
            let longPressTimer = null;

            // æ­Œå•é€‰æ‹©çŠ¶æ€
            let selectedPlaylistIds = new Set();

            // æ­Œå•è¯¦æƒ…é€‰æ‹©çŠ¶æ€
            let selectedDetailIndices = new Set();

            // å¯è§†åŒ–ç›¸å…³
            let audioContext = null;
            let analyser = null;
            let sourceNode = null;
            let canvas = document.getElementById('visualizerCanvas');
            let canvasCtx = canvas.getContext('2d');
            let animationFrame = null;
            let isDraggingProgress = false;

            // ---------- DOM å…ƒç´  ----------
            const playerMain = document.getElementById('playerMain');
            const albumToggle = document.getElementById('albumLyricsToggle');
            const coverDisplay = document.getElementById('coverDisplay');
            const coverImage = document.getElementById('coverImage');
            const coverIcon = document.getElementById('coverIcon');
            const coverSearchBtn = document.getElementById('coverSearchBtn');
            const lyricsDisplayDiv = document.getElementById('lyricsDisplay');
            const lyricTextContainer = document.getElementById('lyricTextContainer');
            const lyricSearchInput = document.getElementById('lyricSearchInput');
            const lyricSearchBtn = document.getElementById('lyricSearchBtn');
            const lyricOffsetUp = document.getElementById('lyricOffsetUp');
            const lyricOffsetDown = document.getElementById('lyricOffsetDown');
            const lyricOffsetReset = document.getElementById('lyricOffsetReset');
            const recentDisplay = document.getElementById('recentDisplay');
            const recentListContainer = document.getElementById('recentListContainer');
            const nowPlayingTitle = document.getElementById('nowPlayingTitle');
            const nowPlayingArtist = document.getElementById('nowPlayingArtist');
            const progressFill = document.getElementById('progressFill');
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');
            const durationTimeEl = document.getElementById('durationTime');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const loopModeBtn = document.getElementById('loopModeBtn');
            const sourceToggleBtn = document.getElementById('sourceToggleBtn');
            const mainSearchInput = document.getElementById('mainSearchInput');
            const mainSearchBtn = document.getElementById('mainSearchBtn');

            // éŸ³è´¨åˆ‡æ¢
            const qualitySwitchContainer = document.getElementById('qualitySwitchContainer');
            const qualitySwitchBtn = document.getElementById('qualitySwitchBtn');
            const qualitySelect = document.getElementById('qualitySelect');

            // æœ¬åœ°éŸ³ä¹å¼¹å±‚
            const localModal = document.getElementById('localMusicModal');
            const localBackBtn = document.getElementById('localBackBtn');
            const localAddBtn = document.getElementById('localAddBtn');
            const localSearchInput = document.getElementById('localSearchInput');
            const localSearchBtn = document.getElementById('localSearchBtn');
            const localItemsList = document.getElementById('localItemsList');
            const localFooter = document.getElementById('localFooter');
            const selectAllLocalBtn = document.getElementById('selectAllLocalBtn');
            const selectedCountSpan = document.getElementById('selectedCount');
            const deleteSelectedLocalBtn = document.getElementById('deleteSelectedLocalBtn');
            const localFolderPicker = document.getElementById('localFolderPicker');

            // æ­Œå•åŒºåŸŸ
            const addPlaylistBtn = document.getElementById('addPlaylistBtn');
            const playlistCreator = document.getElementById('playlistCreator');
            const newPlaylistName = document.getElementById('newPlaylistName');
            const confirmAddPlaylistBtn = document.getElementById('confirmAddPlaylistBtn');
            const playlistItemsContainer = document.getElementById('playlistItemsContainer');
            const playlistDeleteBar = document.getElementById('playlistDeleteBar');
            const deleteSelectedPlaylistsBtn = document.getElementById('deleteSelectedPlaylistsBtn');

            // æ­Œå•è¯¦æƒ…æ¨¡æ€æ¡†
            const detailModal = document.getElementById('playlistDetailModal');
            const detailBackBtn = document.getElementById('detailBackBtn');
            const detailTitle = document.getElementById('detailTitle');
            const detailAddBtn = document.getElementById('detailAddBtn');
            const detailItemsList = document.getElementById('detailItemsList');
            const detailFooter = document.getElementById('detailFooter');
            const selectAllDetailBtn = document.getElementById('selectAllDetailBtn');
            const detailSelectedCount = document.getElementById('detailSelectedCount');
            const deleteSelectedDetailBtn = document.getElementById('deleteSelectedDetailBtn');
            const detailFilePicker = document.getElementById('detailFilePicker');

            // å…¨å±æœç´¢
            const searchModal = document.getElementById('searchModal');
            const closeSearchBtn = document.getElementById('closeSearchBtn');
            const searchInputFull = document.getElementById('searchInputFull');
            const searchResultsContainer = document.getElementById('searchResultsContainer');

            // ---------- è¾…åŠ©å‡½æ•° ----------
            function formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '00:00';
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            }
            function getAuthParams() {
                return `u=${encodeURIComponent(NAV_USER)}&p=${encodeURIComponent(NAV_PASS)}&v=1.16.0&c=MyNavidromePlayer`;
            }

            // ---------- ä¸“è¾‘å°é¢è‡ªåŠ¨è·å–ï¼ˆè‡ªåŠ¨ï¼‰----------
            async function fetchAlbumCover(artist, title) {
                if (!artist || !title) return null;
                try {
                    const url = `https://api.deezer.com/search?q=artist:"${encodeURIComponent(artist)}" track:"${encodeURIComponent(title)}"`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.data && data.data.length > 0) {
                        return data.data[0].album.cover_medium;
                    }
                } catch (e) { console.warn('å°é¢è·å–å¤±è´¥', e); }
                return null;
            }
            async function updateCoverImage(artist, title) {
                const coverUrl = await fetchAlbumCover(artist, title);
                if (coverUrl) {
                    coverImage.src = coverUrl;
                    coverImage.style.display = 'block';
                    coverIcon.style.display = 'none';
                    coverSearchBtn.style.display = 'none';
                } else {
                    coverImage.style.display = 'none';
                    coverIcon.style.display = 'flex';
                    coverSearchBtn.style.display = 'flex'; // æ— å°é¢æ—¶æ˜¾ç¤ºæœç´¢æŒ‰é’®
                }
            }

            // ---------- æ‰‹åŠ¨æœç´¢å°é¢ï¼ˆæ­Œæ‰‹ç…§ç‰‡ï¼‰----------
            function initCoverSearch() {
                coverSearchBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // æ‰“å¼€æœç´¢æ¨¡æ€æ¡†ï¼Œåˆ‡æ¢ä¸ºå°é¢æœç´¢æ¨¡å¼
                    window.__currentSearchMode = 'cover';
                    searchInputFull.placeholder = 'è¾“å…¥æ­Œæ‰‹æˆ–ä¸“è¾‘åç§°...';
                    searchModal.classList.add('show');
                    searchInputFull.value = '';
                    searchInputFull.focus();
                    searchResultsContainer.innerHTML = ''; // æ¸…ç©º
                });
            }

            // æ‰§è¡Œå°é¢æœç´¢ï¼ˆè°ƒç”¨Deezerï¼‰
            async function performCoverSearch(keyword) {
                searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">ğŸ” æœç´¢å›¾ç‰‡ä¸­...</div>';
                try {
                    const url = `https://api.deezer.com/search/album?q=${encodeURIComponent(keyword)}&limit=20`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.data && data.data.length > 0) {
                        let html = '<div class="cover-search-results">';
                        data.data.forEach(album => {
                            const coverUrl = album.cover_medium || album.cover_xl;
                            if (coverUrl) {
                                html += `<div class="cover-search-item" data-url="${coverUrl}">
                                            <img src="${coverUrl}" alt="album cover">
                                        </div>`;
                            }
                        });
                        html += '</div>';
                        searchResultsContainer.innerHTML = html;

                        // ç»‘å®šç‚¹å‡»äº‹ä»¶
                        document.querySelectorAll('.cover-search-item').forEach(el => {
                            el.addEventListener('click', function() {
                                const coverUrl = this.dataset.url;
                                // è®¾ç½®ä¸ºå½“å‰å°é¢
                                coverImage.src = coverUrl;
                                coverImage.style.display = 'block';
                                coverIcon.style.display = 'none';
                                coverSearchBtn.style.display = 'none';
                                // å…³é—­æ¨¡æ€æ¡†
                                searchModal.classList.remove('show');
                            });
                        });
                    } else {
                        searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">æœªæ‰¾åˆ°ç›¸å…³å›¾ç‰‡</div>';
                    }
                } catch (e) {
                    console.error(e);
                    searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                }
            }

            // ---------- å¯è§†åŒ–ï¼šåŒå³°æ³¢å½¢ ----------
            function initVisualizer() {
                if (!canvasCtx) return;
                function resizeCanvas() {
                    const container = canvas.parentElement;
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                }
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                function drawWaveform() {
                    animationFrame = requestAnimationFrame(drawWaveform);
                    const width = canvas.width;
                    const height = canvas.height;
                    canvasCtx.clearRect(0, 0, width, height);

                    let energy = 0.32;
                    const isAudioActive = analyser && currentAudio && !currentAudio.paused && currentAudio.src;
                    if (isAudioActive) {
                        try {
                            const dataArray = new Uint8Array(analyser.frequencyBinCount);
                            analyser.getByteFrequencyData(dataArray);
                            let sum = 0;
                            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                            const avg = sum / dataArray.length / 255;
                            energy = 0.45 + avg * 1.05;
                        } catch (e) { energy = 0.45; }
                    } else {
                        energy = 0.3 + Math.sin(Date.now() * 0.003) * 0.08;
                    }

                    const cycles = 3.0;
                    const phasePerPoint = (cycles * 2 * Math.PI) / width;
                    const centerY = height / 2;
                    const step = 2;

                    canvasCtx.beginPath();
                    canvasCtx.lineWidth = 1.8;
                    canvasCtx.strokeStyle = '#3a3a3a';
                    for (let i = 0; i <= width; i += step) {
                        const t = (i - width/2) / (width/3.5);
                        const gauss = Math.exp(-t * t);
                        const amp = energy * (height * 0.45) * gauss;
                        const y = centerY + amp * Math.sin(i * phasePerPoint);
                        if (i === 0) canvasCtx.moveTo(i, y);
                        else canvasCtx.lineTo(i, y);
                    }
                    canvasCtx.stroke();

                    canvasCtx.beginPath();
                    canvasCtx.lineWidth = 1.2;
                    canvasCtx.strokeStyle = '#5a5a5a';
                    for (let i = 0; i <= width; i += step) {
                        const t = (i - width/2) / (width/3.5);
                        const gauss = Math.exp(-t * t);
                        const amp = energy * (height * 0.35) * gauss;
                        const y = centerY + amp * Math.cos(i * phasePerPoint + 0.8);
                        if (i === 0) canvasCtx.moveTo(i, y);
                        else canvasCtx.lineTo(i, y);
                    }
                    canvasCtx.stroke();

                    canvasCtx.beginPath();
                    canvasCtx.lineWidth = 0.9;
                    canvasCtx.strokeStyle = '#555555';
                    canvasCtx.setLineDash([5, 5]);
                    for (let i = 0; i <= width; i += step) {
                        const t = (i - width/2) / (width/3.5);
                        const gauss = Math.exp(-t * t);
                        const amp = energy * (height * 0.25) * gauss;
                        const y = centerY + amp * Math.sin(i * phasePerPoint * 1.4 + 1.2);
                        if (i === 0) canvasCtx.moveTo(i, y);
                        else canvasCtx.lineTo(i, y);
                    }
                    canvasCtx.stroke();
                    canvasCtx.setLineDash([]);
                }
                drawWaveform();
            }

            function setupAnalyser(audioElement) {
                if (!audioElement) return;
                if (sourceNode) try { sourceNode.disconnect(); } catch(e) {}
                if (analyser) try { analyser.disconnect(); } catch(e) {}
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                if (audioElement.src) {
                    try {
                        sourceNode = audioContext.createMediaElementSource(audioElement);
                        sourceNode.connect(analyser);
                        analyser.connect(audioContext.destination);
                    } catch(e) { console.warn('analyser error', e); }
                }
            }

            // ---------- æ­Œè¯æœç´¢ ----------
            async function fetchLyricsFromAPI(artist, title) {
                if (!artist || !title) return null;
                try {
                    const url = `https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('æ— æ­Œè¯');
                    const data = await res.json();
                    return data.lyrics || null;
                } catch(e) { return null; }
            }

            async function autoFetchLyrics(artist, title) {
                const lyricsText = await fetchLyricsFromAPI(artist, title);
                if (lyricsText) {
                    const lines = lyricsText.split('\n').filter(l => l.trim() !== '');
                    currentLyrics = lines.map((text, idx) => ({ time: idx * 10, text }));
                } else {
                    currentLyrics = [];
                }
                if (displayState === 1) renderLyricsView();
            }

            async function performLyricSearch(keyword) {
                if (!keyword.trim()) return;
                let artist = '', title = '';
                const parts = keyword.trim().split(' ');
                if (parts.length >= 2) {
                    artist = parts[0];
                    title = parts.slice(1).join(' ');
                } else {
                    artist = '';
                    title = keyword;
                }
                const lyrics = await fetchLyricsFromAPI(artist, title);
                if (lyrics) {
                    currentLyrics = lyrics.split('\n').filter(l => l.trim() !== '').map((text, idx) => ({ time: idx * 10 + lyricOffset, text }));
                    if (displayState === 1) renderLyricsView();
                } else {
                    alert('æœªæ‰¾åˆ°æ­Œè¯ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯');
                }
            }

            function adjustLyricOffset(delta) {
                lyricOffset += delta;
                currentLyrics.forEach((line, idx) => { line.time = idx * 10 + lyricOffset; });
                if (currentAudio) highlightLyrics(currentAudio.currentTime);
                lyricOffsetReset.innerText = lyricOffset.toFixed(1) + 's';
            }
            function resetLyricOffset() {
                lyricOffset = 0;
                currentLyrics.forEach((line, idx) => { line.time = idx * 10; });
                if (currentAudio) highlightLyrics(currentAudio.currentTime);
                lyricOffsetReset.innerText = '0.0s';
            }

            function renderLyricsView() {
                if (!currentLyrics || currentLyrics.length === 0) {
                    lyricTextContainer.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">æš‚æ— æ­Œè¯<br><span style="font-size:0.9rem;">ğŸ‘† æœç´¢æ¡†è¾“å…¥ æ­Œæ‰‹ æ­Œå</span></div>';
                    return;
                }
                let html = '';
                currentLyrics.forEach((line, index) => {
                    html += `<div class="lyrics-line" data-time="${line.time}" data-index="${index}">${line.text || 'â‹¯'}</div>`;
                });
                lyricTextContainer.innerHTML = html;
                lyricTextContainer.querySelectorAll('.lyrics-line').forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const time = parseFloat(this.dataset.time);
                        if (currentAudio && !isNaN(time)) currentAudio.currentTime = time;
                    });
                });
                if (currentAudio) highlightLyrics(currentAudio.currentTime);
            }

            function highlightLyrics(currentTime) {
                if (!lyricsDisplayDiv || !currentLyrics.length) return;
                const lines = lyricsDisplayDiv.querySelectorAll('.lyrics-line');
                let activeIndex = -1;
                for (let i = 0; i < currentLyrics.length; i++) {
                    if (currentTime >= currentLyrics[i].time) activeIndex = i;
                    else break;
                }
                lines.forEach((line, idx) => {
                    if (idx === activeIndex) line.classList.add('active');
                    else line.classList.remove('active');
                });
            }

            // ---------- å°é¢/æ­Œè¯/æœ€è¿‘åˆ‡æ¢ ----------
            function toggleDisplayState(e) {
                if (displayState === 1) {
                    const target = e.target;
                    if (target.closest('.lyric-search-btn') || 
                        target.closest('.lyric-search-input') ||
                        target.closest('.lyric-offset-btn') ||
                        target.closest('.lyric-offset-reset') ||
                        target.closest('.lyric-search-bar')) {
                        return;
                    }
                }
                displayState = (displayState + 1) % 3;
                coverDisplay.style.display = displayState === 0 ? 'flex' : 'none';
                lyricsDisplayDiv.style.display = displayState === 1 ? 'flex' : 'none';
                recentDisplay.style.display = displayState === 2 ? 'flex' : 'none';
                if (displayState === 1) renderLyricsView();
                else if (displayState === 2) renderRecentList();
            }

            function renderRecentList() {
                if (recentPlaylist.length === 0) {
                    recentListContainer.innerHTML = '<div style="color:#888; text-align:center; padding:30px;">æš‚æ— æ’­æ”¾è®°å½•</div>';
                    return;
                }
                let html = '';
                recentPlaylist.forEach((item, idx) => {
                    const isActive = (currentSong && currentSong.id === item.id && currentSong.source === item.source) ? 'active' : '';
                    html += `<div class="recent-item ${isActive}" data-index="${idx}">
                                <div class="recent-item-name">${item.name || 'æœªçŸ¥'}</div>
                                <div class="recent-item-artist">${item.artist || 'æœªçŸ¥'}</div>
                            </div>`;
                });
                recentListContainer.innerHTML = html;
                recentListContainer.querySelectorAll('.recent-item').forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const idx = this.dataset.index;
                        const song = recentPlaylist[idx];
                        // é«˜äº®é—ªçƒï¼Œ0.1ç§’åç§»é™¤ï¼ˆæ— å¼¹å±‚ï¼Œä¸å…³é—­ï¼‰
                        flashItem(this, null);
                        if (song.source === 'navidrome') loadNavidromeSong(song);
                        else if (song.source === 'local') playLocalSong(song);
                    });
                });
            }
            function addToRecent(song) {
                const idx = recentPlaylist.findIndex(s => s.id === song.id && s.source === song.source);
                if (idx !== -1) recentPlaylist.splice(idx, 1);
                recentPlaylist.unshift(song);
                if (recentPlaylist.length > 10) recentPlaylist.pop();
                if (displayState === 2) renderRecentList();
            }

            // ---------- é€šç”¨é«˜äº®é—ªçƒå‡½æ•° ----------
            function flashItem(element, callbackAfter) {
                if (!element) return;
                element.classList.add('flash');
                setTimeout(() => {
                    element.classList.remove('flash');
                    if (callbackAfter) callbackAfter();
                }, 100);
            }

            // ---------- Navidrome æ’­æ”¾ ----------
            async function loadNavidromeSong(song, preserveTime = false) {
                if (!song) return;
                const previousTime = currentAudio ? currentAudio.currentTime : 0;
                const wasPlaying = isPlaying;

                currentSong = { ...song, source: 'navidrome' };
                nowPlayingTitle.innerText = song.name || 'æœªçŸ¥';
                nowPlayingArtist.innerText = song.artist || 'æœªçŸ¥';
                addToRecent(currentSong);
                updateCoverImage(song.artist, song.name);

                let streamUrl = `${NAV_ID}/rest/stream?id=${song.id}&${getAuthParams()}`;
                if (currentBitrate > 0) {
                    streamUrl += `&maxBitRate=${currentBitrate}`;
                }

                if (currentAudio) { currentAudio.pause(); currentAudio.src = ''; }
                currentAudio = new Audio(streamUrl);
                currentAudio.crossOrigin = "anonymous";
                currentAudio.load();

                autoFetchLyrics(song.artist, song.name);
                resetLyricOffset();

                currentAudio.addEventListener('timeupdate', function() {
                    if (currentAudio && !isDraggingProgress) {
                        const progress = (currentAudio.currentTime / currentAudio.duration) * 100 || 0;
                        progressFill.style.width = `${progress}%`;
                        currentTimeEl.innerText = formatTime(currentAudio.currentTime);
                        durationTimeEl.innerText = formatTime(currentAudio.duration);
                        if (displayState === 1) highlightLyrics(currentAudio.currentTime);
                    }
                });
                currentAudio.addEventListener('loadedmetadata', function() {
                    durationTimeEl.innerText = formatTime(currentAudio.duration);
                    if (preserveTime && previousTime > 0) {
                        currentAudio.currentTime = previousTime;
                    }
                });
                currentAudio.addEventListener('ended', function() {
                    if (loopMode === 'single') { currentAudio.currentTime = 0; currentAudio.play(); }
                    else playNext();
                });
                setupAnalyser(currentAudio);
                try {
                    await currentAudio.play();
                    isPlaying = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    if (audioContext && audioContext.state === 'suspended') await audioContext.resume();
                } catch(e) {
                    console.error(e);
                    nowPlayingTitle.innerText = 'æ’­æ”¾å¤±è´¥';
                    isPlaying = false;
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                }

                qualitySwitchContainer.style.display = 'block';
            }

            // ---------- éŸ³è´¨åˆ‡æ¢ ----------
            function initQualitySwitch() {
                qualitySwitchBtn.addEventListener('click', function() {
                    qualitySelect.click();
                });
                qualitySelect.addEventListener('change', function() {
                    const newBitrate = parseInt(this.value, 10) || 0;
                    if (currentSong && currentSong.source === 'navidrome') {
                        currentBitrate = newBitrate;
                        loadNavidromeSong(currentSong, true);
                    }
                });
            }

            // ---------- æœ¬åœ°éŸ³ä¹ç®¡ç† ----------
            function scanLocalFiles(files) {
                const audioFiles = Array.from(files).filter(f => f.type.startsWith('audio/'));
                audioFiles.forEach((file, idx) => {
                    const url = URL.createObjectURL(file);
                    localPlaylist.push({
                        id: 'local_' + Date.now() + '_' + idx + Math.random(),
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        artist: 'æœ¬åœ°éŸ³ä¹',
                        url: url,
                        source: 'local'
                    });
                });
                renderLocalList(localPlaylist);
            }

            localFolderPicker.addEventListener('change', function(e) {
                if (window.currentAddingPlaylistId) {
                    addFilesToPlaylist(e.target.files, window.currentAddingPlaylistId);
                    window.currentAddingPlaylistId = null;
                } else {
                    scanLocalFiles(e.target.files);
                }
                localFolderPicker.value = '';
            });

            function playLocalSong(song) {
                if (!song.url) return;
                currentSong = song;
                renderLocalList(localPlaylist); // é«˜äº®

                nowPlayingTitle.innerText = song.name;
                nowPlayingArtist.innerText = song.artist;
                addToRecent(song);
                updateCoverImage(song.artist, song.name);

                if (currentAudio) { currentAudio.pause(); currentAudio.src = ''; }
                currentAudio = new Audio(song.url);
                currentAudio.crossOrigin = "anonymous";
                currentAudio.load();

                currentAudio.addEventListener('timeupdate', function() {
                    if (currentAudio && !isDraggingProgress) {
                        const progress = (currentAudio.currentTime / currentAudio.duration) * 100 || 0;
                        progressFill.style.width = `${progress}%`;
                        currentTimeEl.innerText = formatTime(currentAudio.currentTime);
                        durationTimeEl.innerText = formatTime(currentAudio.duration);
                        if (displayState === 1) highlightLyrics(currentAudio.currentTime);
                    }
                });
                currentAudio.addEventListener('ended', playNext);
                setupAnalyser(currentAudio);
                currentAudio.play().then(() => {
                    isPlaying = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    if (audioContext && audioContext.state === 'suspended') audioContext.resume();
                }).catch(e => console.error);

                currentLyrics = [];
                if (displayState === 1) renderLyricsView();

                qualitySwitchContainer.style.display = 'none';
            }

            function renderLocalList(songs) {
                if (songs.length === 0) {
                    localItemsList.innerHTML = '<li class="local-item" style="justify-content:center; color:#888;">æš‚æ— æ­Œæ›²ï¼Œç‚¹å‡»æ·»åŠ æ–‡ä»¶å¤¹</li>';
                    localFooter.style.display = 'none';
                    return;
                }
                let html = '';
                songs.forEach((item, idx) => {
                    const isActive = (currentSong && currentSong.id === item.id && currentSong.source === 'local') ? 'active' : '';
                    const isSelected = selectedLocalIndices.has(idx) ? 'selected' : '';
                    html += `<li class="local-item ${isActive} ${isSelected}" data-index="${idx}">
                                <div class="local-item-info">
                                    <div class="local-item-name">${item.name || 'æ— é¢˜'}</div>
                                    <div class="local-item-artist">${item.artist || 'æœªçŸ¥'}</div>
                                </div>
                            </li>`;
                });
                localItemsList.innerHTML = html;
                Array.from(localItemsList.children).forEach(el => {
                    const index = parseInt(el.dataset.index, 10);
                    el.addEventListener('click', function(e) {
                        if (selectedLocalIndices.size > 0) {
                            toggleSelectLocal(index);
                        } else {
                            const song = localPlaylist[index];
                            if (song) {
                                // é«˜äº®é—ªçƒï¼Œ0.1ç§’åå…³é—­å¼¹å±‚
                                flashItem(el, () => {
                                    localModal.classList.remove('show');
                                });
                                playLocalSong(song);
                            }
                        }
                    });
                    el.addEventListener('touchstart', handleLongPressStart);
                    el.addEventListener('mousedown', handleLongPressStart);
                    el.addEventListener('touchend', handleLongPressEnd);
                    el.addEventListener('mouseup', handleLongPressEnd);
                    el.addEventListener('touchcancel', handleLongPressEnd);
                    el.addEventListener('mouseleave', handleLongPressEnd);
                });
                updateLocalFooter();
            }

            let pressTimer = null;
            function handleLongPressStart(e) {
                e.preventDefault();
                const el = e.currentTarget;
                pressTimer = setTimeout(() => {
                    const index = parseInt(el.dataset.index, 10);
                    selectedLocalIndices.add(index);
                    renderLocalList(localPlaylist);
                    localFooter.style.display = 'flex';
                    isLongPressing = true;
                }, 500);
            }
            function handleLongPressEnd(e) { clearTimeout(pressTimer); }

            function toggleSelectLocal(index) {
                if (selectedLocalIndices.has(index)) selectedLocalIndices.delete(index);
                else selectedLocalIndices.add(index);
                renderLocalList(localPlaylist);
                if (selectedLocalIndices.size === 0) localFooter.style.display = 'none';
            }

            function updateLocalFooter() {
                const count = selectedLocalIndices.size;
                selectedCountSpan.innerText = `å·²é€‰æ‹© ${count} é¦–`;
                if (count > 0) localFooter.style.display = 'flex';
                else localFooter.style.display = 'none';
            }

            selectAllLocalBtn.addEventListener('click', function() {
                if (selectedLocalIndices.size === localPlaylist.length) {
                    selectedLocalIndices.clear();
                } else {
                    localPlaylist.forEach((_, idx) => selectedLocalIndices.add(idx));
                }
                renderLocalList(localPlaylist);
            });
            deleteSelectedLocalBtn.addEventListener('click', function() {
                if (selectedLocalIndices.size === 0) return;
                if (confirm(`ç¡®è®¤åˆ é™¤ ${selectedLocalIndices.size} é¦–æ­Œæ›²ä»åˆ—è¡¨ä¸­ç§»é™¤ï¼Ÿ`)) {
                    const newPlaylist = localPlaylist.filter((_, idx) => !selectedLocalIndices.has(idx));
                    localPlaylist = newPlaylist;
                    selectedLocalIndices.clear();
                    renderLocalList(localPlaylist);
                    localFooter.style.display = 'none';
                }
            });

            function showLocalModal() {
                renderLocalList(localPlaylist);
                localModal.classList.add('show');
            }
            localBackBtn.addEventListener('click', () => localModal.classList.remove('show'));
            localAddBtn.addEventListener('click', function() {
                localFolderPicker.click();
            });
            localSearchBtn.addEventListener('click', function() {
                const kw = localSearchInput.value.trim().toLowerCase();
                if (!kw) { renderLocalList(localPlaylist); return; }
                const filtered = localPlaylist.filter(s => s.name.toLowerCase().includes(kw) || s.artist.toLowerCase().includes(kw));
                renderLocalList(filtered);
            });

            // ---------- æ­Œå•ç³»ç»Ÿ ----------
            function renderPlaylists() {
                if (userPlaylists.length === 0) {
                    playlistItemsContainer.innerHTML = '<div style="color:#888; padding: 12px; text-align:center;">æš‚æ— æ­Œå•ï¼Œç‚¹å‡»æ·»åŠ </div>';
                    return;
                }
                let html = '';
                userPlaylists.forEach(pl => {
                    const isSelected = selectedPlaylistIds.has(pl.id) ? 'selected' : '';
                    html += `<div class="playlist-item ${isSelected}" data-id="${pl.id}">
                                <div class="playlist-item-info">
                                    <span class="playlist-item-name">${pl.name}</span>
                                    <span class="playlist-item-count">${pl.songs.length}é¦–</span>
                                </div>
                            </div>`;
                });
                playlistItemsContainer.innerHTML = html;

                Array.from(playlistItemsContainer.children).forEach(el => {
                    const plId = el.dataset.id;
                    el.addEventListener('click', function(e) {
                        if (selectedPlaylistIds.size > 0) {
                            toggleSelectPlaylist(plId);
                        } else {
                            showPlaylistDetail(plId);
                        }
                    });
                    el.addEventListener('touchstart', handlePlaylistLongPress);
                    el.addEventListener('mousedown', handlePlaylistLongPress);
                    el.addEventListener('touchend', cancelPlaylistLongPress);
                    el.addEventListener('mouseup', cancelPlaylistLongPress);
                });

                if (selectedPlaylistIds.size > 0) playlistDeleteBar.style.display = 'flex';
                else playlistDeleteBar.style.display = 'none';
            }

            let playlistPressTimer = null;
            function handlePlaylistLongPress(e) {
                e.preventDefault();
                const el = e.currentTarget;
                playlistPressTimer = setTimeout(() => {
                    const plId = el.dataset.id;
                    selectedPlaylistIds.add(plId);
                    renderPlaylists();
                }, 500);
            }
            function cancelPlaylistLongPress() { clearTimeout(playlistPressTimer); }
            function toggleSelectPlaylist(plId) {
                if (selectedPlaylistIds.has(plId)) selectedPlaylistIds.delete(plId);
                else selectedPlaylistIds.add(plId);
                renderPlaylists();
            }

            deleteSelectedPlaylistsBtn.addEventListener('click', function() {
                if (selectedPlaylistIds.size === 0) return;
                if (confirm(`ç¡®è®¤åˆ é™¤ ${selectedPlaylistIds.size} ä¸ªæ­Œå•ï¼Ÿ`)) {
                    userPlaylists = userPlaylists.filter(pl => !selectedPlaylistIds.has(pl.id));
                    selectedPlaylistIds.clear();
                    renderPlaylists();
                }
            });

            addPlaylistBtn.addEventListener('click', function() {
                playlistCreator.style.display = 'flex';
                newPlaylistName.focus();
            });
            confirmAddPlaylistBtn.addEventListener('click', function() {
                const name = newPlaylistName.value.trim();
                if (name) {
                    userPlaylists.push({ id: 'pl_' + Date.now(), name: name, songs: [] });
                    renderPlaylists();
                    playlistCreator.style.display = 'none';
                    newPlaylistName.value = '';
                }
            });

            // ---------- æ­Œå•è¯¦æƒ… ----------
            function showPlaylistDetail(playlistId) {
                const playlist = userPlaylists.find(p => p.id === playlistId);
                if (!playlist) return;
                currentDetailPlaylistId = playlistId;
                detailTitle.innerText = playlist.name;
                renderDetailList(playlistId);
                detailModal.classList.add('show');
            }

            function renderDetailList(playlistId) {
                const playlist = userPlaylists.find(p => p.id === playlistId);
                if (!playlist) return;
                const songs = playlist.songs;
                if (songs.length === 0) {
                    detailItemsList.innerHTML = '<li class="detail-item" style="justify-content:center; color:#888;">æš‚æ— æ­Œæ›²ï¼Œç‚¹å‡»æ·»åŠ æ–‡ä»¶</li>';
                    detailFooter.style.display = 'none';
                    return;
                }
                let html = '';
                songs.forEach((item, idx) => {
                    const isActive = (currentSong && currentSong.id === item.id && currentSong.source === 'local') ? 'active' : '';
                    const isSelected = selectedDetailIndices.has(idx) ? 'selected' : '';
                    html += `<li class="detail-item ${isActive} ${isSelected}" data-index="${idx}">
                                <div class="detail-item-info">
                                    <div class="detail-item-name">${item.name || 'æ— é¢˜'}</div>
                                    <div class="detail-item-artist">${item.artist || 'æœªçŸ¥'}</div>
                                </div>
                            </li>`;
                });
                detailItemsList.innerHTML = html;
                Array.from(detailItemsList.children).forEach(el => {
                    const index = parseInt(el.dataset.index, 10);
                    el.addEventListener('click', function(e) {
                        if (selectedDetailIndices.size > 0) {
                            toggleSelectDetail(index, playlistId);
                        } else {
                            const song = playlist.songs[index];
                            if (song) {
                                // é«˜äº®é—ªçƒï¼Œ0.1ç§’åå…³é—­è¯¦æƒ…å¼¹å±‚
                                flashItem(el, () => {
                                    detailModal.classList.remove('show');
                                });
                                playLocalSong(song);
                            }
                        }
                    });
                    el.addEventListener('touchstart', (e) => handleDetailLongPress(e, index, playlistId));
                    el.addEventListener('mousedown', (e) => handleDetailLongPress(e, index, playlistId));
                    el.addEventListener('touchend', cancelDetailLongPress);
                    el.addEventListener('mouseup', cancelDetailLongPress);
                });
                updateDetailFooter(playlistId);
            }

            let detailPressTimer = null;
            function handleDetailLongPress(e, index, playlistId) {
                e.preventDefault();
                detailPressTimer = setTimeout(() => {
                    selectedDetailIndices.add(index);
                    renderDetailList(playlistId);
                    detailFooter.style.display = 'flex';
                }, 500);
            }
            function cancelDetailLongPress() { clearTimeout(detailPressTimer); }

            function toggleSelectDetail(index, playlistId) {
                if (selectedDetailIndices.has(index)) selectedDetailIndices.delete(index);
                else selectedDetailIndices.add(index);
                renderDetailList(playlistId);
                if (selectedDetailIndices.size === 0) detailFooter.style.display = 'none';
            }

            function updateDetailFooter(playlistId) {
                const count = selectedDetailIndices.size;
                detailSelectedCount.innerText = `å·²é€‰æ‹© ${count} é¦–`;
                if (count > 0) detailFooter.style.display = 'flex';
                else detailFooter.style.display = 'none';
            }

            deleteSelectedDetailBtn.addEventListener('click', function() {
                if (selectedDetailIndices.size === 0 || !currentDetailPlaylistId) return;
                const playlist = userPlaylists.find(p => p.id === currentDetailPlaylistId);
                if (!playlist) return;
                if (confirm(`ç¡®è®¤ä»æ­Œå•ä¸­åˆ é™¤ ${selectedDetailIndices.size} é¦–æ­Œæ›²ï¼Ÿ`)) {
                    const newSongs = playlist.songs.filter((_, idx) => !selectedDetailIndices.has(idx));
                    playlist.songs = newSongs;
                    selectedDetailIndices.clear();
                    renderDetailList(currentDetailPlaylistId);
                }
            });

            selectAllDetailBtn.addEventListener('click', function() {
                const playlist = userPlaylists.find(p => p.id === currentDetailPlaylistId);
                if (!playlist) return;
                if (selectedDetailIndices.size === playlist.songs.length) {
                    selectedDetailIndices.clear();
                } else {
                    playlist.songs.forEach((_, idx) => selectedDetailIndices.add(idx));
                }
                renderDetailList(currentDetailPlaylistId);
            });

            detailBackBtn.addEventListener('click', function() {
                detailModal.classList.remove('show');
                currentDetailPlaylistId = null;
                selectedDetailIndices.clear();
            });

            detailAddBtn.addEventListener('click', function() {
                if (currentDetailPlaylistId) {
                    detailFilePicker.click();
                }
            });

            detailFilePicker.addEventListener('change', function(e) {
                if (currentDetailPlaylistId) {
                    addFilesToPlaylist(e.target.files, currentDetailPlaylistId);
                    detailFilePicker.value = '';
                    renderDetailList(currentDetailPlaylistId);
                }
            });

            function addFilesToPlaylist(files, playlistId) {
                const playlist = userPlaylists.find(p => p.id === playlistId);
                if (!playlist) return;
                const audioFiles = Array.from(files).filter(f => f.type.startsWith('audio/'));
                audioFiles.forEach((file, idx) => {
                    const url = URL.createObjectURL(file);
                    playlist.songs.push({
                        id: 'plsong_' + Date.now() + '_' + idx,
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        artist: 'æœ¬åœ°éŸ³ä¹',
                        url: url,
                        source: 'local'
                    });
                });
                renderPlaylists();
                if (currentDetailPlaylistId === playlistId) {
                    renderDetailList(playlistId);
                }
            }

            // ---------- Navidrome åˆå§‹åŒ– ----------
            async function initNavidromePlaylist() {
                try {
                    const url = `${NAV_ID}/rest/getRandomSongs?size=15&${getAuthParams()}&f=json`;
                    const res = await fetch(url);
                    const json = await res.json();
                    const subsonic = json['subsonic-response'];
                    if (subsonic?.status === 'ok' && subsonic.randomSongs?.song) {
                        let songs = subsonic.randomSongs.song;
                        if (!Array.isArray(songs)) songs = [songs];
                        navidromePlaylist = songs.map(s => ({
                            id: s.id,
                            name: s.title || 'æœªçŸ¥',
                            artist: s.artist || 'æœªçŸ¥',
                            source: 'navidrome'
                        }));
                    }
                } catch(e) { console.warn('è·å–Navidromeå¤±è´¥', e); }
                if (navidromePlaylist.length > 0) {
                    currentIndex = 0;
                    loadNavidromeSong(navidromePlaylist[0]);
                }
            }

            // ---------- æ’­æ”¾æ§åˆ¶ ----------
            function playNext() {
                let list = currentSong?.source === 'navidrome' ? navidromePlaylist : localPlaylist;
                if (list.length === 0) return;
                let idx = list.findIndex(s => s.id === currentSong?.id);
                if (idx === -1) idx = 0;
                if (loopMode === 'random') idx = Math.floor(Math.random() * list.length);
                else idx = (idx + 1) % list.length;
                if (currentSong?.source === 'navidrome') loadNavidromeSong(list[idx]);
                else playLocalSong(list[idx]);
            }
            function playPrev() {
                let list = currentSong?.source === 'navidrome' ? navidromePlaylist : localPlaylist;
                if (list.length === 0) return;
                let idx = list.findIndex(s => s.id === currentSong?.id);
                if (idx === -1) idx = 0;
                if (loopMode === 'random') idx = Math.floor(Math.random() * list.length);
                else idx = (idx - 1 + list.length) % list.length;
                if (currentSong?.source === 'navidrome') loadNavidromeSong(list[idx]);
                else playLocalSong(list[idx]);
            }

            function updateLoopModeIcon() {
                const badge = loopModeBtn.querySelector('.repeat-one-badge');
                if (badge) badge.remove();
                if (loopMode === 'list') loopModeBtn.innerHTML = '<i class="fas fa-repeat"></i>';
                else if (loopMode === 'single') loopModeBtn.innerHTML = '<i class="fas fa-repeat"></i><span class="repeat-one-badge">1</span>';
                else loopModeBtn.innerHTML = '<i class="fas fa-shuffle"></i>';
            }

            // ---------- è¿›åº¦æ¡æ‹–æ‹½ ----------
            function initProgressDrag() {
                progressBar.addEventListener('mousedown', function(e) { e.preventDefault(); isDraggingProgress = true; updateProgress(e); });
                window.addEventListener('mousemove', function(e) { if (isDraggingProgress && currentAudio) updateProgress(e); });
                window.addEventListener('mouseup', function() { isDraggingProgress = false; });
                progressBar.addEventListener('touchstart', function(e) { e.preventDefault(); isDraggingProgress = true; updateProgress(e.touches[0]); });
                window.addEventListener('touchmove', function(e) { if (isDraggingProgress && currentAudio) { e.preventDefault(); updateProgress(e.touches[0]); } });
                window.addEventListener('touchend', function() { isDraggingProgress = false; });

                function updateProgress(e) {
                    if (!currentAudio) return;
                    if (!currentAudio.duration || !isFinite(currentAudio.duration)) return;
                    const rect = progressBar.getBoundingClientRect();
                    let offsetX = e.clientX - rect.left;
                    offsetX = Math.max(0, Math.min(offsetX, rect.width));
                    const percent = offsetX / rect.width;
                    currentAudio.currentTime = percent * currentAudio.duration;
                    progressFill.style.width = `${percent * 100}%`;
                    currentTimeEl.innerText = formatTime(currentAudio.currentTime);
                }
            }

            // ---------- Navidrome æœç´¢ï¼ˆå¸¦ä¸‹è½½ï¼‰----------
            async function performNavidromeSearch(keyword) {
                searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">æœç´¢ä¸­...</div>';
                try {
                    const url = `${NAV_ID}/rest/search3?query=${encodeURIComponent(keyword)}&${getAuthParams()}&f=json`;
                    const res = await fetch(url);
                    const json = await res.json();
                    const subsonic = json['subsonic-response'];
                    if (subsonic?.status === 'ok' && subsonic.searchResult3?.song) {
                        let songs = subsonic.searchResult3.song;
                        if (!Array.isArray(songs)) songs = [songs];
                        let html = '';
                        songs.forEach(song => {
                            html += `<div class="search-result-item" data-id="${song.id}" data-name="${song.title}" data-artist="${song.artist}">
                                        <div class="result-info">
                                            <div class="result-title">${song.title}</div>
                                            <div class="result-artist">${song.artist || ''}</div>
                                        </div>
                                        <button class="result-download-btn" data-id="${song.id}"><i class="fas fa-download"></i></button>
                                    </div>`;
                        });
                        searchResultsContainer.innerHTML = html;

                        document.querySelectorAll('.search-result-item').forEach(el => {
                            el.addEventListener('click', function(e) {
                                if (e.target.closest('.result-download-btn')) return;
                                const song = {
                                    id: this.dataset.id,
                                    name: this.dataset.name,
                                    artist: this.dataset.artist,
                                    source: 'navidrome'
                                };
                                // é«˜äº®é—ªçƒï¼Œ0.1ç§’åå…³é—­æœç´¢æ¨¡æ€æ¡†
                                flashItem(el, () => {
                                    searchModal.classList.remove('show');
                                });
                                if (!navidromePlaylist.some(s => s.id === song.id)) navidromePlaylist.push(song);
                                loadNavidromeSong(song);
                            });
                        });

                        document.querySelectorAll('.result-download-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const id = this.dataset.id;
                                const downloadUrl = `${NAV_ID}/rest/download?id=${id}&${getAuthParams()}`;
                                window.open(downloadUrl, '_blank');
                            });
                        });
                    } else {
                        searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">æœªæ‰¾åˆ°æ­Œæ›²</div>';
                    }
                } catch(e) {
                    console.error(e);
                    searchResultsContainer.innerHTML = '<div style="padding:40px;">æœç´¢å¤±è´¥</div>';
                }
            }

            // ---------- äº‹ä»¶ç»‘å®š ----------
            function bindEvents() {
                albumToggle.addEventListener('click', toggleDisplayState);

                lyricSearchBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const keyword = lyricSearchInput.value.trim();
                    if (keyword) performLyricSearch(keyword);
                });
                lyricOffsetUp.addEventListener('click', function(e) { e.stopPropagation(); adjustLyricOffset(0.5); });
                lyricOffsetDown.addEventListener('click', function(e) { e.stopPropagation(); adjustLyricOffset(-0.5); });
                lyricOffsetReset.addEventListener('click', function(e) { e.stopPropagation(); resetLyricOffset(); });

                playPauseBtn.addEventListener('click', function() {
                    if (!currentAudio && navidromePlaylist.length > 0) loadNavidromeSong(navidromePlaylist[0]);
                    if (isPlaying) {
                        if (currentAudio) currentAudio.pause();
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    } else {
                        if (currentAudio) { currentAudio.play(); if (audioContext?.state === 'suspended') audioContext.resume(); }
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    }
                    isPlaying = !isPlaying;
                });
                prevBtn.addEventListener('click', playPrev);
                nextBtn.addEventListener('click', playNext);
                loopModeBtn.addEventListener('click', function() {
                    if (loopMode === 'list') loopMode = 'single';
                    else if (loopMode === 'single') loopMode = 'random';
                    else loopMode = 'list';
                    updateLoopModeIcon();
                });

                sourceToggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showLocalModal();
                    qualitySwitchContainer.style.display = 'none';
                });

                // Navidrome æœç´¢
                mainSearchBtn.addEventListener('click', function() {
                    window.__currentSearchMode = 'navidrome';
                    searchInputFull.placeholder = 'æœç´¢Navidromeæ›²åº“...';
                    searchModal.classList.add('show');
                    searchInputFull.value = mainSearchInput.value;
                    if (mainSearchInput.value.trim()) performNavidromeSearch(mainSearchInput.value);
                    searchInputFull.focus();
                });
                closeSearchBtn.addEventListener('click', function() { searchModal.classList.remove('show'); });
                searchInputFull.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        if (window.__currentSearchMode === 'cover') {
                            performCoverSearch(searchInputFull.value);
                        } else {
                            performNavidromeSearch(searchInputFull.value);
                        }
                    }
                });

                initProgressDrag();
                initQualitySwitch();
                initCoverSearch();
            }

            // ---------- å¯åŠ¨ ----------
            initNavidromePlaylist();
            bindEvents();
            updateLoopModeIcon();
            initVisualizer();
            displayState = 0;
            coverDisplay.style.display = 'flex';
            lyricsDisplayDiv.style.display = 'none';
            recentDisplay.style.display = 'none';
            renderPlaylists();
        })();
    </script>
</body>
</html>