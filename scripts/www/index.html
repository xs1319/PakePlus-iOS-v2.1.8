<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>极简·黑白 · EchoBeat · 全平台完美版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ===== 全局黑白灰 ——— 基础视觉完全保留 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player {
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* ===== 主内容区域——全局滚动条，包含可视化 ===== */
        .player-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px 24px 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS 流畅滚动 */
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
            transition: scrollbar-color 0.2s;
        }
        .player-main:hover {
            scrollbar-color: #a0a0a0 #f0f0f0;
        }
        .player-main::-webkit-scrollbar {
            width: 4px;
            background: transparent;
        }
        .player-main::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 4px;
        }
        .player-main:hover::-webkit-scrollbar-thumb {
            background: #a0a0a0;
        }
        .player-main:hover::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        /* ----- 新增标题栏：EchoBeat 发光阴影，高度与搜索框区域一致 ----- */
        .app-title-bar {
            width: 100%;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-bottom: 8px;
        }
        .app-title {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: #1a1a1a;
            text-shadow: 0 0 8px rgba(0,0,0,0.15), 0 0 12px rgba(0,0,0,0.1);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* ----- 封面/歌词/最近播放 三合一区域（点击循环切换）----- */
        .album-lyrics-toggle {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f7f7f7;
            border: 1px solid #e2e2e2;
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            flex-shrink: 0;
        }

        .cover-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6f6f6f;
            width: 100%;
            height: 100%;
            position: relative;
        }
        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            display: block;
        }
        .manual-cover-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 8px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* 歌词容器：左侧歌词 + 右下角偏移按钮 */
        .lyrics-container {
            width: 100%;
            height: 100%;
            padding: 16px;
            font-size: 0.95rem;
            line-height: 1.7;
            color: #2a2a2a;
            white-space: pre-wrap;
            overflow-y: auto;
            background: white;
            display: none;
            flex-direction: row;
            position: relative;
        }
        .lyrics-left {
            flex: 1;
            overflow-y: auto;
            padding-right: 12px;
        }
        .lyrics-right {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            width: 48px;
            padding-bottom: 70px;
            margin-top: auto;
        }
        /* 超小屏幕下调整按钮组宽度 */
        @media (max-width: 360px) {
            .lyrics-right {
                width: 40px;
                padding-bottom: 60px;
            }
            .lyric-offset-btn, .lyric-offset-reset {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                margin-bottom: 12px;
            }
            .lyric-offset-reset {
                padding: 6px 0;
            }
        }
        .lyric-offset-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 14px;
            color: #1a1a1a;
        }
        .lyric-offset-reset {
            background: white;
            border: 1px solid #8a8a8a;
            border-radius: 30px;
            padding: 8px 0;
            width: 40px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            margin-bottom: 14px;
        }
        .lyric-manual-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 8px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
        }
        .lyrics-line {
            padding: 6px 0;
            border-bottom: 0.5px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.1s;
        }
        .lyrics-line:hover { background: #f5f5f5; }
        .lyrics-line.active {
            background: #e0e0e0;
            font-weight: 600;
            border-left: 3px solid #1a1a1a;
            padding-left: 9px;
        }

        /* 最近播放列表 */
        .recent-container {
            width: 100%;
            height: 100%;
            background: white;
            padding: 16px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }
        .recent-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
            border-bottom: 1px solid #ececec;
            padding-bottom: 8px;
        }
        .recent-item {
            padding: 12px 16px;
            background: #fafafa;
            border-radius: 16px;
            margin-bottom: 8px;
            border: 1px solid #efefef;
            cursor: pointer;
            transition: 0.1s;
        }
        .recent-item.active {
            background: #e0e0e0;
            border-left: 6px solid #1a1a1a;
        }
        .recent-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .recent-item-artist { font-size: 0.8rem; color: #6e6e6e; }

        /* 歌曲信息 */
        .song-info {
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        .song-title {
            font-size: 1.9rem;
            font-weight: 650;
            letter-spacing: -0.5px;
            color: #000;
            line-height: 1.3;          /* 增加行高，字母下部完整显示 */
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .song-artist {
            font-size: 1rem;
            color: #6a6a6a;
            font-weight: 400;
        }

        /* 进度条区域——相对定位，用于音质按钮绝对定位 */
        .progress-section {
            margin-bottom: 12px;
            flex-shrink: 0;
            position: relative;
        }
        .progress-wrapper {
            width: 100%;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ececec;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        .progress-fill {
            width: 0%;
            height: 4px;
            background: #2c2c2c;
            border-radius: 2px;
            transition: width 0.1s linear;
            pointer-events: none;
        }
        .time-row {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.8rem;
            color: #7a7a7a;
        }
        /* 音质切换按钮——绝对定位，向上移动，完全避开进度条 */
        .quality-switch-container {
            position: absolute;
            right: 0;
            top: -40px;
            display: none;
        }
        .quality-switch-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #1a1a1a;
            white-space: nowrap;
            transition: 0.1s;
        }
        .quality-switch-btn:hover {
            background: #f0f0f0;
        }
        .hidden-select {
            display: none;
        }

        /* 播放控制按钮 */
        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0 16px;
            flex-shrink: 0;
        }
        .control-btn {
            background: white;
            border: 1px solid #d6d6d6;
            font-size: 1.4rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #2b2b2b;
            transition: 0.1s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            position: relative;
        }
        .control-btn:active { background: #f2f2f2; }
        .play-pause { width: 58px; height: 58px; font-size: 1.8rem; border: 1px solid #a8a8a8; }
        .repeat-one-badge {
            position: absolute; top: 12px; right: 10px;
            background: #2b2b2b; color: white; font-size: 0.7rem; font-weight: 700;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }

        /* ===== 搜索媒体库区域（原始大小样式）===== */
        .main-search-section {
            border-top: 1px solid #f0f0f0;
            padding: 16px 0 12px;
            margin-top: 4px;
            flex-shrink: 0;
        }
        .search-wrapper {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #c8c8c8;
            border-radius: 40px;
            padding: 2px 2px 2px 18px;
            transition: 0.1s;
            width: 100%;
        }
        .search-wrapper:focus-within { border-color: #8a8a8a; }
        .search-input {
            background: transparent;
            border: none;
            padding: 12px 0;
            font-size: 1rem;
            flex: 1;
            outline: none;
            color: #1a1a1a;
        }
        .search-btn {
            background: white;
            border: 1px solid #b0b0b0;
            color: #1a1a1a;
            padding: 10px 22px;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.1s;
        }
        .search-btn:hover { background: #f0f0f0; }

        /* ===== 歌单区域 ===== */
        .playlist-section {
            border-top: 1px solid #f0f0f0;
            padding: 16px 0 12px;
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .playlist-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        .playlist-header-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        .add-playlist-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 8px 20px;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .playlist-creator {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
            flex-shrink: 0;
        }
        .playlist-name-input {
            flex: 1;
            border: 1px solid #c2c2c2;
            border-radius: 40px;
            padding: 10px 18px;
            font-size: 0.95rem;
            outline: none;
        }
        .confirm-add-btn {
            background: white;
            border: 1px solid #2a2a2a;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #1a1a1a;
        }
        .playlist-items-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background: #fafafa;
            border-radius: 16px;
            border: 1px solid #efefef;
            cursor: pointer;
            transition: background 0.1s;
            position: relative;
        }
        .playlist-item.selected {
            background: #d4d4d4;
            border: 1.5px solid #4a4a4a;
        }
        .playlist-item-info { flex: 1; }
        .playlist-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .playlist-item-count { font-size: 0.8rem; color: #7a7a7a; margin-left: 8px; }
        .delete-playlist-btn {
            background: white;
            border: 1px solid #b0b0b0;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            flex-shrink: 0;
        }

        /* ===== 可视化：固定高度1/10屏幕，双峰波形 ===== */
        .visualizer-section {
            width: 100%;
            height: 10vh;
            min-height: 60px;
            background: #fafafa;
            border-top: 1px solid #e2e2e2;
            border-bottom: 1px solid #e2e2e2;
            margin-top: 8px;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .visualizer-canvas {
            width: 100%;
            height: 90%;
            display: block;
            background: transparent;
        }

        /* ===== 投送设备列表弹层（取代原本地音乐弹层）===== */
        .cast-device-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex; flex-direction: column;
            padding: 24px 20px;
            transform: scale(0); opacity: 0;
            transition: transform 0.25s cubic-bezier(0.2,0.9,0.3,1), opacity 0.2s;
            transform-origin: center;
            pointer-events: none;
            overflow-y: auto;
        }
        .cast-device-modal.show { transform: scale(1); opacity: 1; pointer-events: auto; }
        .cast-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; position: relative;
        }
        .cast-back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 18px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .cast-title {
            font-size: 1.4rem; font-weight: 600; color: #111;
            position: absolute; left: 50%; transform: translateX(-50%);
        }
        .cast-scanning {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6a6a6a;
            font-size: 0.95rem;
        }
        .cast-device-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding-right: 4px;
            margin-top: 16px;
        }
        .cast-device-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: #fafafa;
            border-radius: 20px;
            margin-bottom: 12px;
            border: 1px solid #efefef;
            cursor: pointer;
            transition: all 0.1s;
        }
        .cast-device-item.active {
            background: #e0e0e0;
            border-left: 6px solid #1a1a1a;
        }
        .cast-device-icon {
            font-size: 1.8rem;
            color: #4a4a4a;
            margin-right: 16px;
        }
        .cast-device-info { flex: 1; }
        .cast-device-name { font-weight: 600; font-size: 1.1rem; color: #1e1e1e; }
        .cast-device-type { font-size: 0.85rem; color: #6e6e6e; margin-top: 4px; }

        /* ===== 歌单详情模态框（仅保留音乐库歌曲）===== */
        .playlist-detail-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2100;
            display: flex; flex-direction: column;
            padding: 24px 20px;
            transform: scale(0); opacity: 0;
            transition: transform 0.25s cubic-bezier(0.2,0.9,0.3,1), opacity 0.2s;
            transform-origin: center;
            pointer-events: none;
            overflow-y: auto;
        }
        .playlist-detail-modal.show { transform: scale(1); opacity: 1; pointer-events: auto; }
        .detail-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; position: relative;
        }
        .detail-back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 18px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .detail-title {
            font-size: 1.4rem; font-weight: 600; color: #111;
            position: absolute; left: 50%; transform: translateX(-50%);
        }
        .detail-add-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 8px 20px; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .detail-items-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding-right: 4px;
        }
        .detail-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: #fafafa;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid #efefef;
            cursor: pointer;
            transition: background 0.1s;
        }
        .detail-item.active {
            background: #e8e8e8;
            border-left: 6px solid #1a1a1a;
        }
        .detail-item-info { flex: 1; }
        .detail-item-name { font-weight: 600; font-size: 1rem; color: #1e1e1e; }
        .detail-item-artist { font-size: 0.85rem; color: #6e6e6e; }

        /* ===== 图片/歌词搜索结果轮播模态框 ===== */
        .search-result-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 3000;
            display: flex; flex-direction: column;
            padding: 24px 20px;
            transform: scale(0); opacity: 0;
            transition: transform 0.25s cubic-bezier(0.2,0.9,0.3,1), opacity 0.2s;
            transform-origin: center;
            pointer-events: none;
            overflow-y: auto;
        }
        .search-result-modal.show { transform: scale(1); opacity: 1; pointer-events: auto; }
        .result-header {
            display: flex; align-items: center; margin-bottom: 30px;
        }
        .result-back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 10px 24px; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .result-title-text {
            font-size: 1.4rem; font-weight: 600; color: #111;
            margin-left: 20px;
        }
        .carousel-container {
            flex: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 20px;
            padding: 20px 10px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .carousel-item {
            flex: 0 0 auto;
            width: 200px;
            height: 200px;
            background: #f5f5f5;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            cursor: pointer;
            scroll-snap-align: start;
            border: 2px solid transparent;
            transition: border 0.1s;
        }
        .carousel-item.selected {
            border: 3px solid #1a1a1a;
        }
        .carousel-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .carousel-text {
            max-height: 180px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 0 10px;
        }

        /* 隐藏文件选择器已移除（本地功能全部砍掉） */
        .hidden { display: none !important; }

        /* ===== 全屏搜索界面（Navidrome）===== */
        .search-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2500;
            display: flex; flex-direction: column;
            padding: 60px 24px 24px;
            transform: translateX(100%);
            transition: transform 0.25s ease-out;
        }
        .search-modal.show { transform: translateX(0); }
        .back-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 40px;
            padding: 12px 24px; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .search-box-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .search-input-large {
            width: 85%;
            max-width: 700px;
            padding: 18px 28px;
            font-size: 1.2rem;
            border: 2px solid #7a7a7a;
            border-radius: 60px;
            outline: none;
            background: white;
            color: #1a1a1a;
        }
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            background: #fafafa;
            border-radius: 20px;
            margin-bottom: 12px;
            border: 1px solid #efefef;
            cursor: pointer;
        }
        .result-info { flex: 1; }
        .result-title { font-weight: 600; font-size: 1.1rem; color: #000; }
        .result-artist { font-size: 0.9rem; color: #6f6f6f; }
        .result-download-btn {
            background: white; border: 1px solid #b0b0b0; border-radius: 50%;
            width: 44px; height: 44px; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #2b2b2b; margin-left: 12px;
        }
    </style>
</head>
<body>
    <div class="player">
        <!-- 主内容区域——全局滚动 -->
        <div class="player-main" id="playerMain">
            <!-- 标题栏 -->
            <div class="app-title-bar">
                <div class="app-title">EchoBeat</div>
            </div>

            <!-- 封面/歌词/最近播放 三合一区域 -->
            <div class="album-lyrics-toggle" id="albumLyricsToggle">
                <!-- 封面（含手动搜图按钮） -->
                <div id="coverDisplay" class="cover-placeholder">
                    <img id="coverImage" class="cover-image" src="" alt="专辑封面" style="display: none;">
                    <div id="coverIcon" style="display: flex; flex-direction: column; align-items: center;">
                        <i class="fas fa-music" style="font-size: 54px; color: #b0b0b0; margin-bottom: 12px;"></i>
                        <span style="color: #7a7a7a; font-size: 1rem;">专辑封面</span>
                    </div>
                    <button class="manual-cover-btn" id="manualCoverSearchBtn"><i class="fas fa-image"></i> 搜图</button>
                </div>
                <!-- 歌词容器（含手动搜索歌词按钮） -->
                <div id="lyricsDisplay" class="lyrics-container">
                    <div class="lyrics-left">
                        <div id="lyricTextContainer"></div>
                    </div>
                    <div class="lyrics-right">
                        <button class="lyric-offset-btn" id="lyricOffsetUp" title="+0.5秒"><i class="fas fa-chevron-up"></i></button>
                        <button class="lyric-offset-reset" id="lyricOffsetReset" title="重置偏移">0.0s</button>
                        <button class="lyric-offset-btn" id="lyricOffsetDown" title="-0.5秒"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <button class="lyric-manual-btn" id="manualLyricSearchBtn"><i class="fas fa-magnifying-glass"></i> 搜歌词</button>
                </div>
                <!-- 最近播放列表 -->
                <div id="recentDisplay" class="recent-container">
                    <div class="recent-title"><i class="fas fa-history"></i> 最近播放</div>
                    <div id="recentListContainer"></div>
                </div>
            </div>

            <!-- 歌曲信息 -->
            <div class="song-info">
                <div class="song-title" id="nowPlayingTitle">连接Navidrome中…</div>
                <div class="song-artist" id="nowPlayingArtist">MrXiao · 音乐库</div>
            </div>

            <!-- 进度条区域 + 音质切换按钮 -->
            <div class="progress-section" id="progressSection">
                <div class="progress-wrapper">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <div class="time-row">
                        <span id="currentTime">00:00</span>
                        <span id="durationTime">00:00</span>
                    </div>
                </div>
                <div id="qualitySwitchContainer" class="quality-switch-container">
                    <button class="quality-switch-btn" id="qualitySwitchBtn">
                        <i class="fas fa-headphones"></i> 音质
                    </button>
                    <select id="qualitySelect" class="hidden-select">
                        <option value="0">原始</option>
                        <option value="128">128kbps</option>
                        <option value="192">192kbps</option>
                        <option value="320" selected>320kbps</option>
                    </select>
                </div>
            </div>

            <!-- 播放控制栏 -->
            <div class="controls">
                <button class="control-btn" id="loopModeBtn" title="循环模式"><i class="fas fa-repeat"></i></button>
                <button class="control-btn" id="prevBtn" title="上一曲"><i class="fas fa-backward"></i></button>
                <button class="control-btn play-pause" id="playPauseBtn" title="播放/暂停"><i class="fas fa-play"></i></button>
                <button class="control-btn" id="nextBtn" title="下一曲"><i class="fas fa-forward"></i></button>
                <button class="control-btn" id="castToggleBtn" title="隔空投送">
                    <i class="fas fa-arrow-up-from-bracket"></i>
                </button>
            </div>

            <!-- 搜索媒体库区域 -->
            <div class="main-search-section">
                <div class="search-wrapper">
                    <input type="text" class="search-input" id="mainSearchInput" placeholder="搜索Navidrome曲库...">
                    <button class="search-btn" id="mainSearchBtn"><i class="fas fa-magnifying-glass"></i> 搜索</button>
                </div>
            </div>

            <!-- 歌单区域 -->
            <div class="playlist-section" id="playlistSection">
                <div class="playlist-header-row">
                    <span class="playlist-header-title"><i class="fas fa-list"></i> 我的歌单</span>
                    <button class="add-playlist-btn" id="addPlaylistBtn"><i class="fas fa-plus"></i> 添加歌单</button>
                </div>
                <div id="playlistCreator" style="display: none;" class="playlist-creator">
                    <input type="text" class="playlist-name-input" id="newPlaylistName" placeholder="歌单名称">
                    <button class="confirm-add-btn" id="confirmAddPlaylistBtn"><i class="fas fa-check"></i></button>
                </div>
                <div id="playlistItemsContainer" class="playlist-items-container"></div>
                <div id="playlistDeleteBar" style="display: none; justify-content: flex-end; margin-top: 12px; flex-shrink: 0;">
                    <button class="delete-playlist-btn" id="deleteSelectedPlaylistsBtn"><i class="fas fa-trash"></i> 删除歌单</button>
                </div>
            </div>

            <!-- 可视化区域 -->
            <div class="visualizer-section">
                <canvas id="visualizerCanvas" class="visualizer-canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- 投送设备列表弹层 -->
    <div class="cast-device-modal" id="castDeviceModal">
        <div class="cast-header">
            <button class="cast-back-btn" id="castBackBtn"><i class="fas fa-arrow-left"></i> 返回</button>
            <span class="cast-title"><i class="fas fa-arrow-up-from-bracket"></i> 隔空投送</span>
            <div class="cast-scanning" id="castScanning">
                <i class="fas fa-spinner fa-spin"></i> 搜索设备...
            </div>
        </div>
        <ul class="cast-device-list" id="castDeviceList"></ul>
    </div>

    <!-- 歌单详情模态框 -->
    <div class="playlist-detail-modal" id="playlistDetailModal">
        <div class="detail-header">
            <button class="detail-back-btn" id="detailBackBtn"><i class="fas fa-arrow-left"></i> 返回</button>
            <span class="detail-title" id="detailTitle">歌单名称</span>
            <button class="detail-add-btn" id="detailAddBtn"><i class="fas fa-plus"></i> 从音乐库添加</button>
        </div>
        <ul class="detail-items-list" id="detailItemsList"></ul>
    </div>

    <!-- 搜索结果轮播模态框 -->
    <div class="search-result-modal" id="searchResultModal">
        <div class="result-header">
            <button class="result-back-btn" id="resultBackBtn"><i class="fas fa-arrow-left"></i> 返回</button>
            <span class="result-title-text" id="resultModalTitle">选择图片</span>
        </div>
        <div class="carousel-container" id="carouselContainer"></div>
    </div>

    <!-- 全屏搜索模态框 -->
    <div class="search-modal" id="searchModal">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <button class="back-btn" id="closeSearchBtn"><i class="fas fa-arrow-left"></i> 返回</button>
        </div>
        <div class="search-header">
            <div class="search-box-wrapper" style="margin-bottom: 0; flex:1;">
                <input type="text" class="search-input-large" id="searchInputFull" placeholder="搜索Navidrome曲库..." autofocus style="width: 100%;">
            </div>
        </div>
        <div class="search-results" id="searchResultsContainer"></div>
    </div>

    <script>
        (function() {
            "use strict";

            // ---------- 配置 ----------
            const NAV_ID = 'https://music.xscc.love:1314';
            const NAV_USER = 'MrXiao';
            const NAV_PASS = 'xs19910410!!!';

            // ---------- 全局状态 ----------
            let currentAudio = null;
            let isPlaying = false;
            let currentSong = null;
            let currentIndex = 0;
            let loopMode = 'list';
            let currentLyrics = [];
            let displayState = 0;
            let lyricOffset = 0;
            
            let currentBitrate = 320;
            let recentPlaylist = [];
            let navidromePlaylist = [];
            let userPlaylists = [];
            let currentDetailPlaylistId = null;
            let selectedPlaylistIds = new Set();

            // 可视化相关
            let audioContext = null;
            let analyser = null;
            let sourceNode = null;
            let canvas = document.getElementById('visualizerCanvas');
            let canvasCtx = canvas.getContext('2d');
            let animationFrame = null;
            let isDraggingProgress = false;

            // 投送设备模拟
            let castDevices = [];
            let currentCastDevice = null;
            let castScanTimer = null;  // 用于清除定时器

            // ---------- DOM 元素 ----------
            const playerMain = document.getElementById('playerMain');
            const albumToggle = document.getElementById('albumLyricsToggle');
            const coverDisplay = document.getElementById('coverDisplay');
            const coverImage = document.getElementById('coverImage');
            const coverIcon = document.getElementById('coverIcon');
            const manualCoverSearchBtn = document.getElementById('manualCoverSearchBtn');
            const lyricsDisplayDiv = document.getElementById('lyricsDisplay');
            const lyricTextContainer = document.getElementById('lyricTextContainer');
            const manualLyricSearchBtn = document.getElementById('manualLyricSearchBtn');
            const lyricOffsetUp = document.getElementById('lyricOffsetUp');
            const lyricOffsetDown = document.getElementById('lyricOffsetDown');
            const lyricOffsetReset = document.getElementById('lyricOffsetReset');
            const recentDisplay = document.getElementById('recentDisplay');
            const recentListContainer = document.getElementById('recentListContainer');
            const nowPlayingTitle = document.getElementById('nowPlayingTitle');
            const nowPlayingArtist = document.getElementById('nowPlayingArtist');
            const progressFill = document.getElementById('progressFill');
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');
            const durationTimeEl = document.getElementById('durationTime');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const loopModeBtn = document.getElementById('loopModeBtn');
            const castToggleBtn = document.getElementById('castToggleBtn');
            const mainSearchInput = document.getElementById('mainSearchInput');
            const mainSearchBtn = document.getElementById('mainSearchBtn');

            const qualitySwitchContainer = document.getElementById('qualitySwitchContainer');
            const qualitySwitchBtn = document.getElementById('qualitySwitchBtn');
            const qualitySelect = document.getElementById('qualitySelect');

            const castModal = document.getElementById('castDeviceModal');
            const castBackBtn = document.getElementById('castBackBtn');
            const castDeviceList = document.getElementById('castDeviceList');
            const castScanning = document.getElementById('castScanning');

            const addPlaylistBtn = document.getElementById('addPlaylistBtn');
            const playlistCreator = document.getElementById('playlistCreator');
            const newPlaylistName = document.getElementById('newPlaylistName');
            const confirmAddPlaylistBtn = document.getElementById('confirmAddPlaylistBtn');
            const playlistItemsContainer = document.getElementById('playlistItemsContainer');
            const playlistDeleteBar = document.getElementById('playlistDeleteBar');
            const deleteSelectedPlaylistsBtn = document.getElementById('deleteSelectedPlaylistsBtn');

            const detailModal = document.getElementById('playlistDetailModal');
            const detailBackBtn = document.getElementById('detailBackBtn');
            const detailTitle = document.getElementById('detailTitle');
            const detailAddBtn = document.getElementById('detailAddBtn');
            const detailItemsList = document.getElementById('detailItemsList');

            const resultModal = document.getElementById('searchResultModal');
            const resultBackBtn = document.getElementById('resultBackBtn');
            const resultModalTitle = document.getElementById('resultModalTitle');
            const carouselContainer = document.getElementById('carouselContainer');

            const searchModal = document.getElementById('searchModal');
            const closeSearchBtn = document.getElementById('closeSearchBtn');
            const searchInputFull = document.getElementById('searchInputFull');
            const searchResultsContainer = document.getElementById('searchResultsContainer');

            // ---------- 辅助函数 ----------
            function formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '00:00';
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            }
            function getAuthParams() {
                return `u=${encodeURIComponent(NAV_USER)}&p=${encodeURIComponent(NAV_PASS)}&v=1.16.0&c=MyNavidromePlayer`;
            }

            // ---------- 高亮后自动返回 ----------
            function highlightAndBack(element, callback) {
                element.classList.add('active');
                setTimeout(() => {
                    element.classList.remove('active');
                    if (callback) callback();
                }, 100);
            }

            // ---------- 封面手动搜索 ----------
            manualCoverSearchBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (!currentSong) return;
                const mockCovers = [
                    'https://e-cdns-images.dzcdn.net/images/cover/123/500x500.jpg',
                    'https://e-cdns-images.dzcdn.net/images/cover/456/500x500.jpg',
                    'https://e-cdns-images.dzcdn.net/images/cover/789/500x500.jpg'
                ];
                resultModalTitle.innerText = `选择“${currentSong.name}”封面`;
                let html = '';
                mockCovers.forEach((url, idx) => {
                    html += `<div class="carousel-item" data-url="${url}">
                                <img src="${url}" class="carousel-image" onerror="this.src='https://via.placeholder.com/120?text=无封面'">
                                <span>封面 ${idx+1}</span>
                            </div>`;
                });
                carouselContainer.innerHTML = html;
                resultModal.classList.add('show');
                
                Array.from(carouselContainer.children).forEach(el => {
                    el.addEventListener('click', function() {
                        const url = this.dataset.url;
                        coverImage.src = url;
                        coverImage.style.display = 'block';
                        coverIcon.style.display = 'none';
                        resultModal.classList.remove('show');
                    });
                });
            });

            // ---------- 歌词手动搜索 ----------
            manualLyricSearchBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (!currentSong) return;
                const mockLyrics = [
                    '作词：某某\n作曲：某某\n\n这是第一段歌词\n这是第二段歌词',
                    '作词：某某\n作曲：某某\n\n另一个版本的歌词\n每行都有不同',
                    '作词：某某\n作曲：某某\n\n纯音乐版本\n暂无歌词'
                ];
                resultModalTitle.innerText = `选择“${currentSong.name}”歌词`;
                let html = '';
                mockLyrics.forEach((text, idx) => {
                    html += `<div class="carousel-item" data-lyrics="${encodeURIComponent(text)}">
                                <div class="carousel-text">${text.substring(0, 50)}...</div>
                                <span style="margin-top:8px;">版本 ${idx+1}</span>
                            </div>`;
                });
                carouselContainer.innerHTML = html;
                resultModal.classList.add('show');

                Array.from(carouselContainer.children).forEach(el => {
                    el.addEventListener('click', function() {
                        const encoded = this.dataset.lyrics;
                        if (encoded) {
                            const lyricsText = decodeURIComponent(encoded);
                            const lines = lyricsText.split('\n').filter(l => l.trim() !== '');
                            currentLyrics = lines.map((text, idx) => ({ time: idx * 10 + lyricOffset, text }));
                            if (displayState === 1) renderLyricsView();
                        }
                        resultModal.classList.remove('show');
                    });
                });
            });

            resultBackBtn.addEventListener('click', () => resultModal.classList.remove('show'));

            // ---------- 专辑封面自动获取 ----------
            async function fetchAlbumCover(artist, title) {
                if (!artist || !title) return null;
                try {
                    const url = `https://api.deezer.com/search?q=artist:"${encodeURIComponent(artist)}" track:"${encodeURIComponent(title)}"`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.data && data.data.length > 0) {
                        return data.data[0].album.cover_medium;
                    }
                } catch (e) { console.warn('封面获取失败', e); }
                return null;
            }
            async function updateCoverImage(artist, title) {
                const coverUrl = await fetchAlbumCover(artist, title);
                if (coverUrl) {
                    coverImage.src = coverUrl;
                    coverImage.style.display = 'block';
                    coverIcon.style.display = 'none';
                } else {
                    coverImage.style.display = 'none';
                    coverIcon.style.display = 'flex';
                }
            }

            // ---------- 可视化 ----------
            function initVisualizer() {
                if (!canvasCtx) return;
                function resizeCanvas() {
                    const container = canvas.parentElement;
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                }
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                function drawWaveform() {
                    animationFrame = requestAnimationFrame(drawWaveform);
                    const width = canvas.width;
                    const height = canvas.height;
                    canvasCtx.clearRect(0, 0, width, height);

                    let energy = 0.32;
                    const isAudioActive = analyser && currentAudio && !currentAudio.paused && currentAudio.src;
                    if (isAudioActive) {
                        try {
                            const dataArray = new Uint8Array(analyser.frequencyBinCount);
                            analyser.getByteFrequencyData(dataArray);
                            let sum = 0;
                            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                            const avg = sum / dataArray.length / 255;
                            energy = 0.45 + avg * 1.05;
                        } catch (e) { energy = 0.45; }
                    } else {
                        energy = 0.3 + Math.sin(Date.now() * 0.003) * 0.08;
                    }

                    const cycles = 3.0;
                    const phasePerPoint = (cycles * 2 * Math.PI) / width;
                    const centerY = height / 2;
                    const step = 2;

                    canvasCtx.beginPath(); canvasCtx.lineWidth = 1.8; canvasCtx.strokeStyle = '#3a3a3a';
                    for (let i = 0; i <= width; i += step) {
                        const t = (i - width/2) / (width/3.5);
                        const gauss = Math.exp(-t * t);
                        const amp = energy * (height * 0.45) * gauss;
                        const y = centerY + amp * Math.sin(i * phasePerPoint);
                        if (i === 0) canvasCtx.moveTo(i, y); else canvasCtx.lineTo(i, y);
                    } canvasCtx.stroke();

                    canvasCtx.beginPath(); canvasCtx.lineWidth = 1.2; canvasCtx.strokeStyle = '#5a5a5a';
                    for (let i = 0; i <= width; i += step) {
                        const t = (i - width/2) / (width/3.5);
                        const gauss = Math.exp(-t * t);
                        const amp = energy * (height * 0.35) * gauss;
                        const y = centerY + amp * Math.cos(i * phasePerPoint + 0.8);
                        if (i === 0) canvasCtx.moveTo(i, y); else canvasCtx.lineTo(i, y);
                    } canvasCtx.stroke();

                    canvasCtx.beginPath(); canvasCtx.lineWidth = 0.9; canvasCtx.strokeStyle = '#555555'; canvasCtx.setLineDash([5,5]);
                    for (let i = 0; i <= width; i += step) {
                        const t = (i - width/2) / (width/3.5);
                        const gauss = Math.exp(-t * t);
                        const amp = energy * (height * 0.25) * gauss;
                        const y = centerY + amp * Math.sin(i * phasePerPoint * 1.4 + 1.2);
                        if (i === 0) canvasCtx.moveTo(i, y); else canvasCtx.lineTo(i, y);
                    } canvasCtx.stroke(); canvasCtx.setLineDash([]);
                }
                drawWaveform();
            }

            function setupAnalyser(audioElement) {
                if (!audioElement) return;
                if (sourceNode) try { sourceNode.disconnect(); } catch(e) {}
                if (analyser) try { analyser.disconnect(); } catch(e) {}
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    // 将在用户手势中 resume
                }
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                if (audioElement.src) {
                    try {
                        sourceNode = audioContext.createMediaElementSource(audioElement);
                        sourceNode.connect(analyser);
                        analyser.connect(audioContext.destination);
                    } catch(e) { console.warn('analyser error', e); }
                }
            }

            // ---------- 歌词 ----------
            async function fetchLyricsFromAPI(artist, title) {
                if (!artist || !title) return null;
                try {
                    const url = `https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('无歌词');
                    const data = await res.json();
                    return data.lyrics || null;
                } catch(e) { return null; }
            }
            async function autoFetchLyrics(artist, title) {
                const lyricsText = await fetchLyricsFromAPI(artist, title);
                if (lyricsText) {
                    const lines = lyricsText.split('\n').filter(l => l.trim() !== '');
                    currentLyrics = lines.map((text, idx) => ({ time: idx * 10, text }));
                } else currentLyrics = [];
                if (displayState === 1) renderLyricsView();
            }
            function renderLyricsView() {
                if (!currentLyrics || currentLyrics.length === 0) {
                    lyricTextContainer.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">暂无歌词<br><span style="font-size:0.9rem;">点击右下角“搜歌词”手动搜索</span></div>';
                    return;
                }
                let html = '';
                currentLyrics.forEach((line, index) => {
                    html += `<div class="lyrics-line" data-time="${line.time}" data-index="${index}">${line.text || '⋯'}</div>`;
                });
                lyricTextContainer.innerHTML = html;
                lyricTextContainer.querySelectorAll('.lyrics-line').forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const time = parseFloat(this.dataset.time);
                        if (currentAudio && !isNaN(time)) currentAudio.currentTime = time;
                    });
                });
                if (currentAudio) highlightLyrics(currentAudio.currentTime);
            }
            function highlightLyrics(currentTime) {
                if (!lyricsDisplayDiv || !currentLyrics.length) return;
                const lines = lyricsDisplayDiv.querySelectorAll('.lyrics-line');
                let activeIndex = -1;
                for (let i = 0; i < currentLyrics.length; i++) {
                    if (currentTime >= currentLyrics[i].time) activeIndex = i; else break;
                }
                lines.forEach((line, idx) => {
                    if (idx === activeIndex) line.classList.add('active'); else line.classList.remove('active');
                });
            }
            function adjustLyricOffset(delta) {
                lyricOffset += delta;
                currentLyrics.forEach((line, idx) => { line.time = idx * 10 + lyricOffset; });
                if (currentAudio) highlightLyrics(currentAudio.currentTime);
                lyricOffsetReset.innerText = lyricOffset.toFixed(1) + 's';
            }
            function resetLyricOffset() {
                lyricOffset = 0;
                currentLyrics.forEach((line, idx) => { line.time = idx * 10; });
                if (currentAudio) highlightLyrics(currentAudio.currentTime);
                lyricOffsetReset.innerText = '0.0s';
            }

            // ---------- 界面切换 ----------
            function toggleDisplayState(e) {
                if (displayState === 1) {
                    const target = e.target;
                    if (target.closest('.lyric-offset-btn') || target.closest('.lyric-offset-reset') || target.closest('.lyric-manual-btn')) return;
                }
                if (displayState === 0) {
                    if (e.target.closest('.manual-cover-btn')) return;
                }
                displayState = (displayState + 1) % 3;
                coverDisplay.style.display = displayState === 0 ? 'flex' : 'none';
                lyricsDisplayDiv.style.display = displayState === 1 ? 'flex' : 'none';
                recentDisplay.style.display = displayState === 2 ? 'flex' : 'none';
                if (displayState === 1) renderLyricsView();
                else if (displayState === 2) renderRecentList();
            }

            function renderRecentList() {
                if (recentPlaylist.length === 0) {
                    recentListContainer.innerHTML = '<div style="color:#888; text-align:center; padding:30px;">暂无播放记录</div>';
                    return;
                }
                let html = '';
                recentPlaylist.forEach((item, idx) => {
                    const isActive = (currentSong && currentSong.id === item.id && currentSong.source === item.source) ? 'active' : '';
                    html += `<div class="recent-item ${isActive}" data-index="${idx}">
                                <div class="recent-item-name">${item.name || '未知'}</div>
                                <div class="recent-item-artist">${item.artist || '未知'}</div>
                            </div>`;
                });
                recentListContainer.innerHTML = html;
                recentListContainer.querySelectorAll('.recent-item').forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const idx = this.dataset.index;
                        const song = recentPlaylist[idx];
                        if (song.source === 'navidrome') {
                            highlightAndBack(this, () => loadNavidromeSong(song));
                        }
                    });
                });
            }
            function addToRecent(song) {
                const idx = recentPlaylist.findIndex(s => s.id === song.id && s.source === song.source);
                if (idx !== -1) recentPlaylist.splice(idx, 1);
                recentPlaylist.unshift(song);
                if (recentPlaylist.length > 10) recentPlaylist.pop();
                if (displayState === 2) renderRecentList();
            }

            // ---------- Navidrome 播放 ----------
            async function loadNavidromeSong(song, preserveTime = false) {
                if (!song) return;
                const previousTime = currentAudio ? currentAudio.currentTime : 0;
                currentSong = { ...song, source: 'navidrome' };
                nowPlayingTitle.innerText = song.name || '未知';
                nowPlayingArtist.innerText = song.artist || '未知';
                addToRecent(currentSong);
                updateCoverImage(song.artist, song.name);

                let streamUrl = `${NAV_ID}/rest/stream?id=${song.id}&${getAuthParams()}`;
                if (currentBitrate > 0) streamUrl += `&maxBitRate=${currentBitrate}`;

                if (currentAudio) { currentAudio.pause(); currentAudio.src = ''; }
                currentAudio = new Audio(streamUrl);
                currentAudio.crossOrigin = "anonymous";
                currentAudio.load();

                autoFetchLyrics(song.artist, song.name);
                resetLyricOffset();

                currentAudio.addEventListener('timeupdate', function() {
                    if (currentAudio && !isDraggingProgress) {
                        const progress = (currentAudio.currentTime / currentAudio.duration) * 100 || 0;
                        progressFill.style.width = `${progress}%`;
                        currentTimeEl.innerText = formatTime(currentAudio.currentTime);
                        durationTimeEl.innerText = formatTime(currentAudio.duration);
                        if (displayState === 1) highlightLyrics(currentAudio.currentTime);
                    }
                });
                currentAudio.addEventListener('loadedmetadata', function() {
                    durationTimeEl.innerText = formatTime(currentAudio.duration);
                    if (preserveTime && previousTime > 0) currentAudio.currentTime = previousTime;
                });
                currentAudio.addEventListener('ended', function() {
                    if (loopMode === 'single') { currentAudio.currentTime = 0; currentAudio.play(); }
                    else playNext();
                });
                setupAnalyser(currentAudio);
                try {
                    // 确保 AudioContext 已恢复
                    if (audioContext && audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    await currentAudio.play();
                    isPlaying = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } catch(e) {
                    console.error(e);
                    nowPlayingTitle.innerText = '播放失败，请检查网络或服务器CORS';
                    isPlaying = false;
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
                qualitySwitchContainer.style.display = 'block';
            }

            // ---------- 音质切换 ----------
            function initQualitySwitch() {
                qualitySwitchBtn.addEventListener('click', function() { qualitySelect.click(); });
                qualitySelect.addEventListener('change', function() {
                    const newBitrate = parseInt(this.value, 10) || 0;
                    if (currentSong && currentSong.source === 'navidrome') {
                        currentBitrate = newBitrate;
                        loadNavidromeSong(currentSong, true);
                    }
                });
            }

            // ---------- 投送设备 ----------
            function scanCastDevices() {
                if (castScanTimer) clearTimeout(castScanTimer);
                castScanning.style.display = 'flex';
                castScanTimer = setTimeout(() => {
                    castDevices = [
                        { id: 'tv1', name: '客厅电视', type: 'TV (AirPlay)', icon: 'fa-tv' },
                        { id: 'speaker1', name: '书房音响', type: 'AirPlay Speaker', icon: 'fa-speaker' },
                        { id: 'cast1', name: '卧室Chromecast', type: 'Google Cast', icon: 'fa-cast' }
                    ];
                    renderCastDeviceList();
                    castScanning.style.display = 'none';
                }, 1500);
            }
            function renderCastDeviceList() {
                let html = '';
                castDevices.forEach(dev => {
                    const isActive = (currentCastDevice && currentCastDevice.id === dev.id) ? 'active' : '';
                    html += `<li class="cast-device-item ${isActive}" data-id="${dev.id}">
                                <i class="fas ${dev.icon} cast-device-icon"></i>
                                <div class="cast-device-info">
                                    <div class="cast-device-name">${dev.name}</div>
                                    <div class="cast-device-type">${dev.type}</div>
                                </div>
                            </li>`;
                });
                castDeviceList.innerHTML = html;
                Array.from(castDeviceList.children).forEach(el => {
                    el.addEventListener('click', function() {
                        const id = this.dataset.id;
                        const device = castDevices.find(d => d.id === id);
                        if (device) {
                            highlightAndBack(this, () => {
                                currentCastDevice = device;
                                castModal.classList.remove('show');
                                alert(`正在投送到 ${device.name}\n(音量同步已模拟)`);
                            });
                        }
                    });
                });
            }
            castToggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                castModal.classList.add('show');
                scanCastDevices();
            });
            castBackBtn.addEventListener('click', () => castModal.classList.remove('show'));

            // ---------- 歌单系统 ----------
            function renderPlaylists() {
                if (userPlaylists.length === 0) {
                    playlistItemsContainer.innerHTML = '<div style="color:#888; padding: 12px; text-align:center;">暂无歌单，点击添加</div>';
                    return;
                }
                let html = '';
                userPlaylists.forEach(pl => {
                    const isSelected = selectedPlaylistIds.has(pl.id) ? 'selected' : '';
                    html += `<div class="playlist-item ${isSelected}" data-id="${pl.id}">
                                <div class="playlist-item-info">
                                    <span class="playlist-item-name">${pl.name}</span>
                                    <span class="playlist-item-count">${pl.songs.length}首</span>
                                </div>
                            </div>`;
                });
                playlistItemsContainer.innerHTML = html;

                Array.from(playlistItemsContainer.children).forEach(el => {
                    const plId = el.dataset.id;
                    el.addEventListener('click', function(e) {
                        if (selectedPlaylistIds.size > 0) {
                            toggleSelectPlaylist(plId);
                        } else {
                            showPlaylistDetail(plId);
                        }
                    });
                    el.addEventListener('touchstart', handlePlaylistLongPress);
                    el.addEventListener('mousedown', handlePlaylistLongPress);
                    el.addEventListener('touchend', cancelPlaylistLongPress);
                    el.addEventListener('mouseup', cancelPlaylistLongPress);
                });

                if (selectedPlaylistIds.size > 0) playlistDeleteBar.style.display = 'flex';
                else playlistDeleteBar.style.display = 'none';
            }

            let playlistPressTimer = null;
            function handlePlaylistLongPress(e) {
                e.preventDefault();
                const el = e.currentTarget;
                playlistPressTimer = setTimeout(() => {
                    const plId = el.dataset.id;
                    selectedPlaylistIds.add(plId);
                    renderPlaylists();
                }, 500);
            }
            function cancelPlaylistLongPress() { clearTimeout(playlistPressTimer); }
            function toggleSelectPlaylist(plId) {
                if (selectedPlaylistIds.has(plId)) selectedPlaylistIds.delete(plId);
                else selectedPlaylistIds.add(plId);
                renderPlaylists();
            }

            deleteSelectedPlaylistsBtn.addEventListener('click', function() {
                if (selectedPlaylistIds.size === 0) return;
                if (confirm(`确认删除 ${selectedPlaylistIds.size} 个歌单？`)) {
                    userPlaylists = userPlaylists.filter(pl => !selectedPlaylistIds.has(pl.id));
                    selectedPlaylistIds.clear();
                    renderPlaylists();
                }
            });

            addPlaylistBtn.addEventListener('click', function() {
                playlistCreator.style.display = 'flex';
                newPlaylistName.focus();
            });
            confirmAddPlaylistBtn.addEventListener('click', function() {
                const name = newPlaylistName.value.trim();
                if (name) {
                    userPlaylists.push({ id: 'pl_' + Date.now(), name: name, songs: [] });
                    renderPlaylists();
                    playlistCreator.style.display = 'none';
                    newPlaylistName.value = '';
                }
            });

            function showPlaylistDetail(playlistId) {
                const playlist = userPlaylists.find(p => p.id === playlistId);
                if (!playlist) return;
                currentDetailPlaylistId = playlistId;
                detailTitle.innerText = playlist.name;
                renderDetailList(playlistId);
                detailModal.classList.add('show');
            }

            function renderDetailList(playlistId) {
                const playlist = userPlaylists.find(p => p.id === playlistId);
                if (!playlist) return;
                const songs = playlist.songs;
                if (songs.length === 0) {
                    detailItemsList.innerHTML = '<li class="detail-item" style="justify-content:center; color:#888;">暂无歌曲，点击上方添加音乐库歌曲</li>';
                    return;
                }
                let html = '';
                songs.forEach((item, idx) => {
                    const isActive = (currentSong && currentSong.id === item.id && currentSong.source === 'navidrome') ? 'active' : '';
                    html += `<li class="detail-item ${isActive}" data-index="${idx}" data-song-id="${item.id}">
                                <div class="detail-item-info">
                                    <div class="detail-item-name">${item.name || '无题'}</div>
                                    <div class="detail-item-artist">${item.artist || '未知'}</div>
                                </div>
                            </li>`;
                });
                detailItemsList.innerHTML = html;
                Array.from(detailItemsList.children).forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const index = parseInt(this.dataset.index, 10);
                        const song = playlist.songs[index];
                        if (song) {
                            highlightAndBack(this, () => {
                                loadNavidromeSong(song);
                                detailModal.classList.remove('show');
                            });
                        }
                    });
                });
            }

            detailBackBtn.addEventListener('click', function() {
                detailModal.classList.remove('show');
                currentDetailPlaylistId = null;
            });

            detailAddBtn.addEventListener('click', function() {
                if (!currentDetailPlaylistId) return;
                window.currentAddingPlaylistId = currentDetailPlaylistId;
                searchModal.classList.add('show');
                searchInputFull.value = '';
                searchInputFull.focus();
                searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">搜索要添加的歌曲</div>';
            });

            // ---------- Navidrome 搜索 ----------
            async function performNavidromeSearch(keyword) {
                searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">搜索中...</div>';
                try {
                    const url = `${NAV_ID}/rest/search3?query=${encodeURIComponent(keyword)}&${getAuthParams()}&f=json`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    const subsonic = json['subsonic-response'];
                    if (subsonic?.status === 'ok' && subsonic.searchResult3?.song) {
                        let songs = subsonic.searchResult3.song;
                        if (!Array.isArray(songs)) songs = [songs];
                        let html = '';
                        songs.forEach(song => {
                            html += `<div class="search-result-item" data-id="${song.id}" data-name="${song.title}" data-artist="${song.artist}">
                                        <div class="result-info">
                                            <div class="result-title">${song.title}</div>
                                            <div class="result-artist">${song.artist || ''}</div>
                                        </div>
                                        <button class="result-download-btn" data-id="${song.id}"><i class="fas fa-download"></i></button>
                                    </div>`;
                        });
                        searchResultsContainer.innerHTML = html;

                        document.querySelectorAll('.search-result-item').forEach(el => {
                            el.addEventListener('click', function(e) {
                                if (e.target.closest('.result-download-btn')) return;
                                const song = {
                                    id: this.dataset.id,
                                    name: this.dataset.name,
                                    artist: this.dataset.artist,
                                    source: 'navidrome'
                                };
                                if (window.currentAddingPlaylistId) {
                                    const playlist = userPlaylists.find(p => p.id === window.currentAddingPlaylistId);
                                    if (playlist && !playlist.songs.some(s => s.id === song.id)) {
                                        playlist.songs.push(song);
                                    }
                                    window.currentAddingPlaylistId = null;
                                    searchModal.classList.remove('show');
                                    renderPlaylists();
                                    if (currentDetailPlaylistId) renderDetailList(currentDetailPlaylistId);
                                } else {
                                    if (!navidromePlaylist.some(s => s.id === song.id)) navidromePlaylist.push(song);
                                    highlightAndBack(el, () => {
                                        loadNavidromeSong(song);
                                        searchModal.classList.remove('show');
                                    });
                                }
                            });
                        });

                        document.querySelectorAll('.result-download-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const id = this.dataset.id;
                                window.open(`${NAV_ID}/rest/download?id=${id}&${getAuthParams()}`, '_blank');
                            });
                        });
                    } else {
                        searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">未找到歌曲</div>';
                    }
                } catch(e) {
                    console.error(e);
                    searchResultsContainer.innerHTML = '<div style="padding:40px; text-align:center;">搜索失败，请检查服务器地址或CORS配置</div>';
                }
            }

            // ---------- 初始化 Navidrome ----------
            async function initNavidromePlaylist() {
                try {
                    const url = `${NAV_ID}/rest/getRandomSongs?size=15&${getAuthParams()}&f=json`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    const subsonic = json['subsonic-response'];
                    if (subsonic?.status === 'ok' && subsonic.randomSongs?.song) {
                        let songs = subsonic.randomSongs.song;
                        if (!Array.isArray(songs)) songs = [songs];
                        navidromePlaylist = songs.map(s => ({
                            id: s.id,
                            name: s.title || '未知',
                            artist: s.artist || '未知',
                            source: 'navidrome'
                        }));
                    } else {
                        throw new Error('歌单为空');
                    }
                } catch(e) {
                    console.warn('获取Navidrome失败', e);
                    nowPlayingTitle.innerText = '无法连接音乐库';
                    nowPlayingArtist.innerText = '请检查网络或CORS设置';
                    navidromePlaylist = [];
                }
                if (navidromePlaylist.length > 0) {
                    currentIndex = 0;
                    loadNavidromeSong(navidromePlaylist[0]);
                }
            }

            // ---------- 播放控制 ----------
            function playNext() {
                let list = navidromePlaylist;
                if (list.length === 0) return;
                let idx = list.findIndex(s => s.id === currentSong?.id);
                if (idx === -1) idx = 0;
                if (loopMode === 'random') idx = Math.floor(Math.random() * list.length);
                else idx = (idx + 1) % list.length;
                loadNavidromeSong(list[idx]);
            }
            function playPrev() {
                let list = navidromePlaylist;
                if (list.length === 0) return;
                let idx = list.findIndex(s => s.id === currentSong?.id);
                if (idx === -1) idx = 0;
                if (loopMode === 'random') idx = Math.floor(Math.random() * list.length);
                else idx = (idx - 1 + list.length) % list.length;
                loadNavidromeSong(list[idx]);
            }

            function updateLoopModeIcon() {
                const badge = loopModeBtn.querySelector('.repeat-one-badge');
                if (badge) badge.remove();
                if (loopMode === 'list') loopModeBtn.innerHTML = '<i class="fas fa-repeat"></i>';
                else if (loopMode === 'single') loopModeBtn.innerHTML = '<i class="fas fa-repeat"></i><span class="repeat-one-badge">1</span>';
                else loopModeBtn.innerHTML = '<i class="fas fa-shuffle"></i>';
            }

            // ---------- 进度条拖动 ----------
            function initProgressDrag() {
                progressBar.addEventListener('mousedown', function(e) { e.preventDefault(); isDraggingProgress = true; updateProgress(e); });
                window.addEventListener('mousemove', function(e) { if (isDraggingProgress && currentAudio) updateProgress(e); });
                window.addEventListener('mouseup', function() { isDraggingProgress = false; });
                progressBar.addEventListener('touchstart', function(e) { e.preventDefault(); isDraggingProgress = true; updateProgress(e.touches[0]); });
                window.addEventListener('touchmove', function(e) { if (isDraggingProgress && currentAudio) { e.preventDefault(); updateProgress(e.touches[0]); } });
                window.addEventListener('touchend', function() { isDraggingProgress = false; });

                function updateProgress(e) {
                    if (!currentAudio) return;
                    if (!currentAudio.duration || !isFinite(currentAudio.duration)) return;
                    const rect = progressBar.getBoundingClientRect();
                    let offsetX = e.clientX - rect.left;
                    offsetX = Math.max(0, Math.min(offsetX, rect.width));
                    const percent = offsetX / rect.width;
                    currentAudio.currentTime = percent * currentAudio.duration;
                    progressFill.style.width = `${percent * 100}%`;
                    currentTimeEl.innerText = formatTime(currentAudio.currentTime);
                }
            }

            // ---------- 事件绑定 ----------
            function bindEvents() {
                albumToggle.addEventListener('click', toggleDisplayState);

                lyricOffsetUp.addEventListener('click', function(e) { e.stopPropagation(); adjustLyricOffset(0.5); });
                lyricOffsetDown.addEventListener('click', function(e) { e.stopPropagation(); adjustLyricOffset(-0.5); });
                lyricOffsetReset.addEventListener('click', function(e) { e.stopPropagation(); resetLyricOffset(); });

                playPauseBtn.addEventListener('click', async function() {
                    if (!currentAudio && navidromePlaylist.length > 0) {
                        loadNavidromeSong(navidromePlaylist[0]);
                        return;
                    }
                    if (isPlaying) {
                        if (currentAudio) currentAudio.pause();
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    } else {
                        if (currentAudio) {
                            if (audioContext && audioContext.state === 'suspended') await audioContext.resume();
                            currentAudio.play();
                        }
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    }
                    isPlaying = !isPlaying;
                });

                prevBtn.addEventListener('click', playPrev);
                nextBtn.addEventListener('click', playNext);
                loopModeBtn.addEventListener('click', function() {
                    if (loopMode === 'list') loopMode = 'single';
                    else if (loopMode === 'single') loopMode = 'random';
                    else loopMode = 'list';
                    updateLoopModeIcon();
                });

                mainSearchBtn.addEventListener('click', function() {
                    window.currentAddingPlaylistId = null;
                    searchModal.classList.add('show');
                    searchInputFull.value = mainSearchInput.value;
                    if (mainSearchInput.value.trim()) performNavidromeSearch(mainSearchInput.value);
                    searchInputFull.focus();
                });
                closeSearchBtn.addEventListener('click', function() { searchModal.classList.remove('show'); });
                searchInputFull.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') { performNavidromeSearch(searchInputFull.value); }
                });

                initProgressDrag();
                initQualitySwitch();
            }

            // ---------- 启动 ----------
            initNavidromePlaylist();
            bindEvents();
            updateLoopModeIcon();
            initVisualizer();
            displayState = 0;
            coverDisplay.style.display = 'flex';
            lyricsDisplayDiv.style.display = 'none';
            recentDisplay.style.display = 'none';
            renderPlaylists();
        })();
    </script>
</body>
</html>